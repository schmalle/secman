package com.secman.cli.commands

import org.junit.jupiter.api.DisplayName
import org.junit.jupiter.api.Nested
import org.junit.jupiter.api.Test
import org.assertj.core.api.Assertions.assertThat
import picocli.CommandLine

/**
 * Unit tests for AddVulnerabilityCommand parameter validation.
 * Feature: 056-test-suite (User Story 1 - P1)
 *
 * Tests CLI parameter validation:
 * - Required parameter enforcement
 * - Criticality enum validation
 * - Days-open validation
 */
@DisplayName("AddVulnerabilityCommand Parameter Validation")
class AddVulnerabilityCommandTest {

    @Nested
    @DisplayName("Required Parameters")
    inner class RequiredParameterTests {

        @Test
        @DisplayName("CLI-003: Requires hostname parameter")
        fun `requiresHostname`() {
            val cmd = CommandLine(AddVulnerabilityCommand())

            // Command should define hostname as required
            val optionSpec = cmd.commandSpec.findOption("--hostname")
            assertThat(optionSpec).isNotNull
            assertThat(optionSpec?.required()).isTrue()
        }

        @Test
        @DisplayName("CLI-004: Requires cve parameter")
        fun `requiresCve`() {
            val cmd = CommandLine(AddVulnerabilityCommand())

            // Command should define cve as required
            val optionSpec = cmd.commandSpec.findOption("--cve")
            assertThat(optionSpec).isNotNull
            assertThat(optionSpec?.required()).isTrue()
        }

        @Test
        @DisplayName("CLI-005: Requires criticality parameter")
        fun `requiresCriticality`() {
            val cmd = CommandLine(AddVulnerabilityCommand())

            // Command should define criticality as required
            val optionSpec = cmd.commandSpec.findOption("--criticality")
            assertThat(optionSpec).isNotNull
            assertThat(optionSpec?.required()).isTrue()
        }
    }

    @Nested
    @DisplayName("Criticality Validation")
    inner class CriticalityValidationTests {

        @Test
        @DisplayName("CLI-001: Accepts valid criticality values")
        fun `acceptsValidCriticalityValues`() {
            val validValues = listOf("CRITICAL", "HIGH", "MEDIUM", "LOW")

            validValues.forEach { criticality ->
                val cmd = CommandLine(AddVulnerabilityCommand())
                val result = cmd.parseArgs(
                    "--hostname", "test-host",
                    "--cve", "CVE-2024-001",
                    "--criticality", criticality,
                    "--username", "admin",
                    "--password", "pass"
                )

                val command = cmd.getCommand<AddVulnerabilityCommand>()
                assertThat(command.criticality).isEqualTo(criticality)
            }
        }

        @Test
        @DisplayName("CLI-007: Normalizes lowercase criticality to uppercase internally")
        fun `normalizeCriticalityCase`() {
            // Note: The actual normalization happens in the service/DTO layer
            // Here we test that the command accepts the input
            val cmd = CommandLine(AddVulnerabilityCommand())

            // Parse lowercase criticality
            cmd.parseArgs(
                "--hostname", "test-host",
                "--cve", "CVE-2024-001",
                "--criticality", "high",
                "--username", "admin",
                "--password", "pass"
            )

            val command = cmd.getCommand<AddVulnerabilityCommand>()
            // Command stores as-is, normalization happens in backend DTO
            assertThat(command.criticality).isEqualTo("high")
        }
    }

    @Nested
    @DisplayName("Days Open Validation")
    inner class DaysOpenValidationTests {

        @Test
        @DisplayName("CLI-006: Accepts valid inputs including days-open")
        fun `acceptsValidInputs`() {
            val cmd = CommandLine(AddVulnerabilityCommand())

            cmd.parseArgs(
                "--hostname", "test-host",
                "--cve", "CVE-2024-001",
                "--criticality", "HIGH",
                "--days-open", "60",
                "--username", "admin",
                "--password", "pass"
            )

            val command = cmd.getCommand<AddVulnerabilityCommand>()
            assertThat(command.hostname).isEqualTo("test-host")
            assertThat(command.cve).isEqualTo("CVE-2024-001")
            assertThat(command.criticality).isEqualTo("HIGH")
            assertThat(command.daysOpen).isEqualTo(60)
        }

        @Test
        @DisplayName("CLI-002: Days-open defaults to 0")
        fun `daysOpenDefaultsToZero`() {
            val cmd = CommandLine(AddVulnerabilityCommand())

            cmd.parseArgs(
                "--hostname", "test-host",
                "--cve", "CVE-2024-001",
                "--criticality", "HIGH",
                "--username", "admin",
                "--password", "pass"
                // No --days-open specified
            )

            val command = cmd.getCommand<AddVulnerabilityCommand>()
            assertThat(command.daysOpen).isEqualTo(0)
        }

        @Test
        @DisplayName("Days-open accepts zero")
        fun `daysOpenAcceptsZero`() {
            val cmd = CommandLine(AddVulnerabilityCommand())

            cmd.parseArgs(
                "--hostname", "test-host",
                "--cve", "CVE-2024-001",
                "--criticality", "HIGH",
                "--days-open", "0",
                "--username", "admin",
                "--password", "pass"
            )

            val command = cmd.getCommand<AddVulnerabilityCommand>()
            assertThat(command.daysOpen).isEqualTo(0)
        }

        @Test
        @DisplayName("Days-open accepts large values")
        fun `daysOpenAcceptsLargeValues`() {
            val cmd = CommandLine(AddVulnerabilityCommand())

            cmd.parseArgs(
                "--hostname", "test-host",
                "--cve", "CVE-2024-001",
                "--criticality", "HIGH",
                "--days-open", "365",
                "--username", "admin",
                "--password", "pass"
            )

            val command = cmd.getCommand<AddVulnerabilityCommand>()
            assertThat(command.daysOpen).isEqualTo(365)
        }
    }

    @Nested
    @DisplayName("Backend URL Configuration")
    inner class BackendUrlTests {

        @Test
        @DisplayName("Backend URL defaults to localhost:8080")
        fun `backendUrlDefaults`() {
            val cmd = CommandLine(AddVulnerabilityCommand())

            cmd.parseArgs(
                "--hostname", "test-host",
                "--cve", "CVE-2024-001",
                "--criticality", "HIGH",
                "--username", "admin",
                "--password", "pass"
            )

            val command = cmd.getCommand<AddVulnerabilityCommand>()
            assertThat(command.backendUrl).isEqualTo("http://localhost:8080")
        }

        @Test
        @DisplayName("Backend URL can be overridden")
        fun `backendUrlCanBeOverridden`() {
            val cmd = CommandLine(AddVulnerabilityCommand())

            cmd.parseArgs(
                "--hostname", "test-host",
                "--cve", "CVE-2024-001",
                "--criticality", "HIGH",
                "--backend-url", "https://secman.example.com",
                "--username", "admin",
                "--password", "pass"
            )

            val command = cmd.getCommand<AddVulnerabilityCommand>()
            assertThat(command.backendUrl).isEqualTo("https://secman.example.com")
        }
    }
}
