package com.secman.cli.commands

import com.secman.dto.AddVulnerabilityRequestDto
import com.secman.service.VulnerabilityService
import io.micronaut.configuration.picocli.PicocliRunner
import jakarta.inject.Inject
import picocli.CommandLine.Command
import picocli.CommandLine.Option

/**
 * CLI command to add a vulnerability to an asset
 * Feature: 052-cli-add-vulnerability, 073-cli-direct-db
 *
 * Usage:
 *   secman add-vulnerability --hostname <host> --cve <cve> --criticality <level> [options]
 *
 * Examples:
 *   secman add-vulnerability --hostname webserver01 --cve CVE-2024-1234 --criticality HIGH --days-open 30
 *   secman add-vulnerability --hostname newserver99 --cve CVE-2023-5678 --criticality CRITICAL
 */
@Command(
    name = "add-vulnerability",
    description = ["Add or update a vulnerability for a hostname"],
    mixinStandardHelpOptions = true
)
class AddVulnerabilityCommand : Runnable {

    @Inject
    lateinit var vulnerabilityService: VulnerabilityService

    // Required parameters
    @Option(
        names = ["--hostname"],
        description = ["Target asset hostname (required)"],
        required = true
    )
    lateinit var hostname: String

    @Option(
        names = ["--cve"],
        description = ["CVE identifier (required, e.g., CVE-2024-1234)"],
        required = true
    )
    lateinit var cve: String

    @Option(
        names = ["--criticality"],
        description = ["Severity level: CRITICAL, HIGH, MEDIUM, or LOW (required)"],
        required = true,
        completionCandidates = CriticalityCandidates::class
    )
    lateinit var criticality: String

    // Optional parameters
    @Option(
        names = ["--days-open"],
        description = ["Number of days the vulnerability has been open (default: 0)"],
        defaultValue = "0"
    )
    var daysOpen: Int = 0

    @Option(
        names = ["--verbose", "-v"],
        description = ["Enable verbose output"]
    )
    var verbose: Boolean = false

    override fun run() {
        // Validate criticality value
        val validCriticalities = listOf("CRITICAL", "HIGH", "MEDIUM", "LOW")
        val normalizedCriticality = criticality.uppercase()
        if (normalizedCriticality !in validCriticalities) {
            System.err.println("Error: Criticality must be CRITICAL, HIGH, MEDIUM, or LOW")
            System.err.println("   Received: $criticality")
            System.exit(1)
            return
        }

        // Validate days-open value
        if (daysOpen < 0) {
            System.err.println("Error: Days open must be a positive number or zero")
            System.err.println("   Received: $daysOpen")
            System.exit(1)
            return
        }

        println("============================================================")
        println("Add Vulnerability")
        println("============================================================")
        println()

        // Display request details
        if (verbose) {
            println("Processing vulnerability...")
            println("Hostname: $hostname")
            println("CVE: $cve")
            println("Criticality: $normalizedCriticality")
            println("Days Open: $daysOpen")
            println()
        }

        // Add vulnerability directly via service
        try {
            val request = AddVulnerabilityRequestDto(
                hostname = hostname,
                cve = cve,
                criticality = normalizedCriticality,
                daysOpen = daysOpen
            )

            val result = vulnerabilityService.addVulnerabilityFromCli(request)

            // Display result
            if (result.success) {
                if (result.assetCreated) {
                    println("Asset ${result.assetName} created (type: SERVER, owner: CLI-IMPORT)")
                }

                val operationEmoji = when (result.operation) {
                    "CREATED" -> "+"
                    "UPDATED" -> "~"
                    else -> "*"
                }
                println("$operationEmoji ${result.message}")
                println()
                println("============================================================")
                println("Summary")
                println("============================================================")
                println("Asset: ${result.assetName}${if (result.assetCreated) " (auto-created)" else ""}")
                println("Operation: ${result.operation}${if (result.operation == "UPDATED") " (existing vulnerability)" else ""}")
            } else {
                System.err.println("Error: ${result.message}")
                System.exit(1)
                return
            }
        } catch (e: IllegalArgumentException) {
            System.err.println("Error: ${e.message}")
            System.exit(1)
            return
        } catch (e: Exception) {
            System.err.println("Error: ${e.message}")
            if (verbose) {
                e.printStackTrace()
            }
            System.exit(1)
            return
        }
    }

    /**
     * Completion candidates for criticality option
     */
    class CriticalityCandidates : Iterable<String> {
        override fun iterator(): Iterator<String> {
            return listOf("CRITICAL", "HIGH", "MEDIUM", "LOW").iterator()
        }
    }
}
