package com.secman.cli.commands

import com.secman.cli.service.VulnerabilityCliService
import io.micronaut.configuration.picocli.PicocliRunner
import jakarta.inject.Inject
import picocli.CommandLine.Command
import picocli.CommandLine.Option

/**
 * CLI command to add a vulnerability to an asset
 * Feature: 052-cli-add-vulnerability
 *
 * Usage:
 *   secman add-vulnerability --hostname <host> --cve <cve> --criticality <level> [options]
 *
 * Examples:
 *   secman add-vulnerability --hostname webserver01 --cve CVE-2024-1234 --criticality HIGH --days-open 30 --username admin --password secret
 *   secman add-vulnerability --hostname newserver99 --cve CVE-2023-5678 --criticality CRITICAL --username admin --password secret
 *
 * User Stories:
 * - US1: Add vulnerability to existing asset (P1)
 * - US2: Add vulnerability with auto-created asset (P2)
 * - US3: Validation and error handling (P3)
 */
@Command(
    name = "add-vulnerability",
    description = ["Add or update a vulnerability for a hostname"],
    mixinStandardHelpOptions = true
)
class AddVulnerabilityCommand : Runnable {

    @Inject
    lateinit var vulnerabilityCliService: VulnerabilityCliService

    // Required parameters (US3: FR-002)
    @Option(
        names = ["--hostname"],
        description = ["Target asset hostname (required)"],
        required = true
    )
    lateinit var hostname: String

    @Option(
        names = ["--cve"],
        description = ["CVE identifier (required, e.g., CVE-2024-1234)"],
        required = true
    )
    lateinit var cve: String

    @Option(
        names = ["--criticality"],
        description = ["Severity level: CRITICAL, HIGH, MEDIUM, or LOW (required)"],
        required = true,
        completionCandidates = CriticalityCandidates::class
    )
    lateinit var criticality: String

    // Optional parameters (FR-003, FR-012, FR-013)
    @Option(
        names = ["--days-open"],
        description = ["Number of days the vulnerability has been open (default: 0)"],
        defaultValue = "0"
    )
    var daysOpen: Int = 0

    @Option(
        names = ["--backend-url"],
        description = ["Backend API URL (default: http://localhost:8080)"],
        defaultValue = "http://localhost:8080"
    )
    var backendUrl: String = "http://localhost:8080"

    @Option(
        names = ["--username", "-u"],
        description = ["Backend username (or set SECMAN_USERNAME env var)"],
        required = false
    )
    var username: String? = null

    @Option(
        names = ["--password", "-p"],
        description = ["Backend password (or set SECMAN_PASSWORD env var)"],
        required = false
    )
    var password: String? = null

    @Option(
        names = ["--verbose", "-v"],
        description = ["Enable verbose output"]
    )
    var verbose: Boolean = false

    override fun run() {
        // Resolve credentials from environment variables if not provided via CLI
        val effectiveUsername = username
            ?: System.getenv("SECMAN_USERNAME")
            ?: run {
                System.err.println("Error: Username required via --username or SECMAN_USERNAME env var")
                System.exit(1)
                return
            }

        val effectivePassword = password
            ?: System.getenv("SECMAN_PASSWORD")
            ?: run {
                System.err.println("Error: Password required via --password or SECMAN_PASSWORD env var")
                System.exit(1)
                return
            }

        // US3: Validate criticality value (FR-004)
        val validCriticalities = listOf("CRITICAL", "HIGH", "MEDIUM", "LOW")
        val normalizedCriticality = criticality.uppercase()
        if (normalizedCriticality !in validCriticalities) {
            System.err.println("Error: Criticality must be CRITICAL, HIGH, MEDIUM, or LOW")
            System.err.println("   Received: $criticality")
            System.exit(1)
            return
        }

        // US3: Validate days-open value (FR-003)
        if (daysOpen < 0) {
            System.err.println("Error: Days open must be a positive number or zero")
            System.err.println("   Received: $daysOpen")
            System.exit(1)
            return
        }

        println("============================================================")
        println("Add Vulnerability")
        println("============================================================")
        println()

        // Step 1: Authenticate
        println("Authenticating with backend...")
        val token = vulnerabilityCliService.authenticate(effectiveUsername, effectivePassword, backendUrl)

        if (token == null) {
            System.err.println("Error: Authentication failed")
            System.err.println("   Check username and password")
            System.exit(1)
            return
        }
        println("Authentication successful")
        println()

        // Step 2: Display request details
        if (verbose) {
            println("Processing vulnerability...")
            println("Hostname: $hostname")
            println("CVE: $cve")
            println("Criticality: $normalizedCriticality")
            println("Days Open: $daysOpen")
            println()
        }

        // Step 3: Add vulnerability
        val result = vulnerabilityCliService.addVulnerability(
            hostname = hostname,
            cve = cve,
            criticality = normalizedCriticality,
            daysOpen = daysOpen,
            backendUrl = backendUrl,
            authToken = token
        )

        // Step 4: Display result (FR-010)
        if (result.success) {
            if (result.assetCreated) {
                println("Asset ${result.assetName} created (type: SERVER, owner: CLI-IMPORT)")
            }

            val operationEmoji = when (result.operation) {
                "CREATED" -> "+"
                "UPDATED" -> "~"
                else -> "*"
            }
            println("$operationEmoji ${result.message}")
            println()
            println("============================================================")
            println("Summary")
            println("============================================================")
            println("Asset: ${result.assetName}${if (result.assetCreated) " (auto-created)" else ""}")
            println("Operation: ${result.operation}${if (result.operation == "UPDATED") " (existing vulnerability)" else ""}")
        } else {
            System.err.println("Error: ${result.message}")
            System.exit(result.exitCode)
            return
        }
    }

    /**
     * Completion candidates for criticality option
     * Provides tab completion for valid criticality values
     */
    class CriticalityCandidates : Iterable<String> {
        override fun iterator(): Iterator<String> {
            return listOf("CRITICAL", "HIGH", "MEDIUM", "LOW").iterator()
        }
    }
}
