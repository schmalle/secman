# Add Vulnerability Command

**Feature**: 052-cli-add-vulnerability
**Version**: 1.0.0
**Last Updated**: 2025-12-07

## Overview

The `add-vulnerability` command provides a CLI tool for manually adding vulnerability records to assets in SecMan. This is useful for recording vulnerabilities discovered through manual penetration testing, security audits, or external reports that are not automatically imported from CrowdStrike.

**Key Features**:
- Add vulnerability to existing asset by hostname
- Auto-create asset if hostname not found
- Upsert pattern: update existing CVE record instead of creating duplicates
- Validate criticality levels and days-open values
- Clear success/failure feedback with exit codes

## Prerequisites

### Authentication
All operations require authentication with a user that has **ADMIN** or **VULN** role. Specify credentials via:
- `--username <user>` and `--password <pass>` flags (required)

### Backend Connection
The command connects to the SecMan backend API. Ensure:
- Backend server is running and accessible
- Default URL: `http://localhost:8080`
- Override with `--backend-url` if needed

---

## Command Syntax

```bash
./gradlew cli:run --args='add-vulnerability \
  --hostname <hostname> \
  --cve <cve-id> \
  --criticality <level> \
  [--days-open <number>] \
  [--backend-url <url>] \
  [--username <user>] \
  [--password <pass>] \
  [--verbose]'
```

**Note**: `--username` and `--password` are optional if `SECMAN_USERNAME` and `SECMAN_PASSWORD` environment variables are set.

### Required Options

| Option | Description | Example |
|--------|-------------|---------|
| `--hostname` | Target asset hostname | `webserver01` |
| `--cve` | CVE identifier or custom vulnerability ID | `CVE-2024-1234` |
| `--criticality` | Severity level: CRITICAL, HIGH, MEDIUM, or LOW | `HIGH` |
| `--username`, `-u` | Backend username (or set `SECMAN_USERNAME` env var) | `admin` |
| `--password`, `-p` | Backend password (or set `SECMAN_PASSWORD` env var) | `secret` |

### Optional Options

| Option | Description | Default |
|--------|-------------|---------|
| `--days-open` | Number of days the vulnerability has been open | `0` |
| `--backend-url` | Backend API URL | `http://localhost:8080` |
| `--verbose`, `-v` | Enable detailed logging output | `false` |

---

## Examples

### Basic Usage - Add Vulnerability to Existing Asset

```bash
./gradlew cli:run --args='add-vulnerability \
  --hostname webserver01 \
  --cve CVE-2024-1234 \
  --criticality HIGH \
  --username admin \
  --password secret'
```

**Output:**
```
============================================================
Add Vulnerability
============================================================

Authenticating with backend...
Authentication successful

+ Vulnerability CVE-2024-1234 added to asset webserver01

============================================================
Summary
============================================================
Asset: webserver01
Operation: CREATED
```

### With Days Open

```bash
./gradlew cli:run --args='add-vulnerability \
  --hostname dbserver02 \
  --cve CVE-2023-5678 \
  --criticality CRITICAL \
  --days-open 45 \
  --username admin \
  --password secret'
```

### Auto-Create Asset (Hostname Not Found)

When the hostname doesn't exist in SecMan, the asset is automatically created with default values.

```bash
./gradlew cli:run --args='add-vulnerability \
  --hostname newserver99 \
  --cve CVE-2024-9999 \
  --criticality MEDIUM \
  --days-open 15 \
  --username admin \
  --password secret'
```

**Output:**
```
============================================================
Add Vulnerability
============================================================

Authenticating with backend...
Authentication successful

Asset newserver99 created (type: SERVER, owner: CLI-IMPORT)
+ Asset newserver99 created. Vulnerability CVE-2024-9999 added.

============================================================
Summary
============================================================
Asset: newserver99 (auto-created)
Operation: CREATED
```

**Auto-created asset defaults:**
- **Type**: `SERVER`
- **Owner**: `CLI-IMPORT`
- **Last Seen**: Current timestamp

### Update Existing Vulnerability (Upsert)

If the same CVE already exists for the asset, the command updates the existing record instead of creating a duplicate.

```bash
# First add
./gradlew cli:run --args='add-vulnerability \
  --hostname webserver01 \
  --cve CVE-2024-1234 \
  --criticality HIGH \
  --days-open 30 \
  --username admin \
  --password secret'

# Update the same CVE with new days-open
./gradlew cli:run --args='add-vulnerability \
  --hostname webserver01 \
  --cve CVE-2024-1234 \
  --criticality HIGH \
  --days-open 45 \
  --username admin \
  --password secret'
```

**Output (second run):**
```
============================================================
Add Vulnerability
============================================================

Authenticating with backend...
Authentication successful

~ Vulnerability CVE-2024-1234 updated on asset webserver01

============================================================
Summary
============================================================
Asset: webserver01
Operation: UPDATED (existing vulnerability)
```

### Verbose Mode

```bash
./gradlew cli:run --args='add-vulnerability \
  --hostname webserver01 \
  --cve CVE-2024-1234 \
  --criticality HIGH \
  --days-open 30 \
  --username admin \
  --password secret \
  --verbose'
```

**Output:**
```
============================================================
Add Vulnerability
============================================================

Authenticating with backend...
Authentication successful

Processing vulnerability...
Hostname: webserver01
CVE: CVE-2024-1234
Criticality: HIGH
Days Open: 30

+ Vulnerability CVE-2024-1234 added to asset webserver01

============================================================
Summary
============================================================
Asset: webserver01
Operation: CREATED
```

### Custom Backend URL

```bash
./gradlew cli:run --args='add-vulnerability \
  --hostname webserver01 \
  --cve CVE-2024-1234 \
  --criticality HIGH \
  --backend-url https://api.example.com:8080 \
  --username admin \
  --password secret'
```

---

## Validation Rules

### Criticality Values

Valid values (case-insensitive):
- `CRITICAL`
- `HIGH`
- `MEDIUM`
- `LOW`

**Invalid value error:**
```
Error: Criticality must be CRITICAL, HIGH, MEDIUM, or LOW
   Received: IMPORTANT
```

### Days Open

- Must be a non-negative integer (>= 0)
- Default: `0` (vulnerability discovered today)

**Invalid value error:**
```
Error: Days open must be a positive number or zero
   Received: -5
```

### CVE Format

- Any string format is accepted
- Allows non-standard identifiers for manual entries
- Examples: `CVE-2024-1234`, `VULN-001`, `INTERNAL-SEC-2024-05`

### Hostname

- Required, non-blank
- Case-insensitive lookup in database
- If not found, auto-creates asset

---

## Exit Codes

| Code | Meaning |
|------|---------|
| `0` | Success - vulnerability added or updated |
| `1` | Validation error, authentication failure, or API error |
| `2` | Backend connection error (cannot reach server) |

**Example script using exit codes:**
```bash
#!/bin/bash

./gradlew cli:run --args='add-vulnerability \
  --hostname server01 \
  --cve CVE-2024-1234 \
  --criticality HIGH \
  --username admin \
  --password secret'

case $? in
  0) echo "Vulnerability added successfully" ;;
  1) echo "Error: Check parameters or authentication" ;;
  2) echo "Error: Cannot connect to backend" ;;
esac
```

---

## Data Model

### Vulnerability Record

When a vulnerability is added, the following fields are set:

| Field | Source | Example |
|-------|--------|---------|
| `vulnerabilityId` | `--cve` parameter | `CVE-2024-1234` |
| `cvssSeverity` | `--criticality` (title case) | `High` |
| `daysOpen` | `--days-open` as text | `30 days` |
| `scanTimestamp` | Calculated: now - days-open | `2024-10-08T10:30:00` |
| `importTimestamp` | Current time | `2024-11-07T10:30:00` |
| `asset` | Found or created by hostname | webserver01 |

### Criticality Mapping

| CLI Input | Database Value |
|-----------|----------------|
| `CRITICAL` | `Critical` |
| `HIGH` | `High` |
| `MEDIUM` | `Medium` |
| `LOW` | `Low` |

---

## Common Workflows

### 1. Record Penetration Test Findings

After a penetration test, manually add discovered vulnerabilities:

```bash
# Add multiple findings from pen test report
./gradlew cli:run --args='add-vulnerability \
  --hostname app-server-01 \
  --cve CVE-2024-1234 \
  --criticality CRITICAL \
  --days-open 0 \
  --username admin \
  --password secret'

./gradlew cli:run --args='add-vulnerability \
  --hostname app-server-01 \
  --cve CVE-2024-5678 \
  --criticality HIGH \
  --days-open 0 \
  --username admin \
  --password secret'

./gradlew cli:run --args='add-vulnerability \
  --hostname db-server-01 \
  --cve CVE-2024-9999 \
  --criticality MEDIUM \
  --days-open 0 \
  --username admin \
  --password secret'
```

### 2. Batch Import from Script

Create a script to import multiple vulnerabilities:

```bash
#!/bin/bash
# import-vulns.sh

BACKEND_URL="http://localhost:8080"
USERNAME="admin"
PASSWORD="secret"

while IFS=',' read -r hostname cve criticality days_open; do
  echo "Adding: $hostname - $cve ($criticality)"

  ./gradlew cli:run --args="add-vulnerability \
    --hostname $hostname \
    --cve $cve \
    --criticality $criticality \
    --days-open ${days_open:-0} \
    --backend-url $BACKEND_URL \
    --username $USERNAME \
    --password $PASSWORD"

  if [ $? -ne 0 ]; then
    echo "Failed to add: $hostname - $cve"
  fi
done < vulnerabilities.csv
```

**vulnerabilities.csv:**
```csv
webserver01,CVE-2024-1234,HIGH,30
webserver01,CVE-2024-5678,CRITICAL,15
dbserver02,CVE-2024-9999,MEDIUM,45
newserver99,CVE-2024-0001,LOW,0
```

### 3. Update Vulnerability Age

Update the days-open for an existing vulnerability:

```bash
# Original entry with 30 days
./gradlew cli:run --args='add-vulnerability \
  --hostname webserver01 \
  --cve CVE-2024-1234 \
  --criticality HIGH \
  --days-open 30 \
  --username admin \
  --password secret'

# After 15 more days, update to 45 days
./gradlew cli:run --args='add-vulnerability \
  --hostname webserver01 \
  --cve CVE-2024-1234 \
  --criticality HIGH \
  --days-open 45 \
  --username admin \
  --password secret'
```

### 4. Track Non-CVE Vulnerabilities

Use custom identifiers for internal findings:

```bash
./gradlew cli:run --args='add-vulnerability \
  --hostname internal-app \
  --cve INTERNAL-SEC-2024-001 \
  --criticality HIGH \
  --days-open 10 \
  --username admin \
  --password secret'
```

---

## Troubleshooting

### Issue: "Username required via --username or SECMAN_USERNAME env var"

**Cause**: No username provided
**Solution**:
- Set `SECMAN_USERNAME` environment variable, OR
- Pass `--username` flag

```bash
# Option 1: Set environment variable
export SECMAN_USERNAME=admin

# Option 2: Pass via command line
./gradlew cli:run --args='add-vulnerability ... --username admin'
```

### Issue: "Password required via --password or SECMAN_PASSWORD env var"

**Cause**: No password provided
**Solution**:
- Set `SECMAN_PASSWORD` environment variable (recommended), OR
- Pass `--password` flag

```bash
# Option 1: Set environment variable (recommended)
export SECMAN_PASSWORD=secret

# Option 2: Pass via command line (less secure)
./gradlew cli:run --args='add-vulnerability ... --password secret'
```

### Issue: "Authentication failed"

**Cause**: Invalid username or password
**Solution**:
- Verify credentials are correct
- Ensure user has ADMIN or VULN role

```bash
# Test authentication
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"secret"}'
```

### Issue: "Cannot connect to backend"

**Cause**: Backend server unreachable
**Solution**:
- Verify backend is running
- Check `--backend-url` is correct
- Test network connectivity

```bash
# Test connectivity
curl http://localhost:8080/health
```

### Issue: "Insufficient permissions"

**Cause**: User lacks required role
**Solution**: Ensure user has ADMIN or VULN role

### Issue: "Criticality must be CRITICAL, HIGH, MEDIUM, or LOW"

**Cause**: Invalid criticality value
**Solution**: Use one of the valid values (case-insensitive)

### Issue: Vulnerability not appearing in UI

**Cause**: Various
**Solution**:
1. Verify the asset exists (check if auto-created)
2. Check user has access to the asset's workgroup
3. Refresh the vulnerabilities view

---

## Security Considerations

1. **Role-Based Access**: Only ADMIN and VULN roles can add vulnerabilities
2. **Audit Logging**: All additions/updates are logged with user identity
3. **Input Validation**: All parameters validated before database operations
4. **Credential Handling**: Supports environment variables to avoid exposing credentials in process listings
5. **HTTPS Recommended**: Use `--backend-url https://...` in production

### Authentication Methods

**Method 1 - Environment Variables (Recommended):**

Environment variables keep credentials out of process listings and shell history:

```bash
# Set credentials once
export SECMAN_USERNAME=admin
export SECMAN_PASSWORD=secret

# Run commands without exposing credentials
./gradlew cli:run --args='add-vulnerability \
  --hostname webserver01 \
  --cve CVE-2024-1234 \
  --criticality HIGH'
```

**Method 2 - Command Line Arguments:**

For quick testing or single-user environments:

```bash
./gradlew cli:run --args='add-vulnerability \
  --hostname webserver01 \
  --cve CVE-2024-1234 \
  --criticality HIGH \
  --username admin \
  --password secret'
```

⚠️ **Warning**: Command line arguments are visible in:
- Process listings (`ps aux`)
- Shell history (`~/.bash_history`, `~/.zsh_history`)
- System logs

**Method 3 - Mixed (Override Environment):**

Command line arguments take precedence over environment variables:

```bash
export SECMAN_USERNAME=default_user
export SECMAN_PASSWORD=default_pass

# Override username for this command only
./gradlew cli:run --args='add-vulnerability \
  --hostname webserver01 \
  --cve CVE-2024-1234 \
  --criticality HIGH \
  --username different_user'
```

### Environment Variables Reference

| Variable | Description |
|----------|-------------|
| `SECMAN_USERNAME` | Backend username for authentication |
| `SECMAN_PASSWORD` | Backend password for authentication |

---

## API Endpoint

The CLI calls the following backend endpoint:

**Endpoint**: `POST /api/vulnerabilities/cli-add`
**Auth**: Bearer JWT token (obtained via `/api/auth/login`)
**Roles**: ADMIN, VULN

**Request Body:**
```json
{
  "hostname": "webserver01",
  "cve": "CVE-2024-1234",
  "criticality": "HIGH",
  "daysOpen": 30
}
```

**Response:**
```json
{
  "success": true,
  "message": "Vulnerability CVE-2024-1234 added to asset webserver01",
  "assetName": "webserver01",
  "assetCreated": false,
  "vulnerabilityId": "CVE-2024-1234",
  "operation": "CREATED"
}
```

---

## Related Documentation

- **Feature Spec**: `specs/052-cli-add-vulnerability/spec.md`
- **Implementation Plan**: `specs/052-cli-add-vulnerability/plan.md`
- **Task Breakdown**: `specs/052-cli-add-vulnerability/tasks.md`
- **Quickstart Guide**: `specs/052-cli-add-vulnerability/quickstart.md`
- **API Contract**: `specs/052-cli-add-vulnerability/contracts/api.yaml`
- **CLI Reference**: `docs/CLI.md`

---

## Support

For issues or questions:
1. Check troubleshooting guide above
2. Verify backend logs: `./gradlew backendng:run`
3. Enable verbose mode: `--verbose`
4. Report bugs: https://github.com/schmalle/secman/issues

---

**End of Add Vulnerability Command Documentation**
