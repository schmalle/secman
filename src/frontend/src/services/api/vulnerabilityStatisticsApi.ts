/**
 * API client for vulnerability statistics endpoints
 *
 * Provides TypeScript interfaces and methods for accessing the vulnerability statistics API.
 * All requests include JWT authentication from localStorage (authToken).
 *
 * Feature: 036-vuln-stats-lense
 * Task: T007
 * Spec reference: spec.md Section "API Endpoints"
 * Contract: contracts/vulnerability-statistics-api.yaml
 */

import axios from 'axios';

// Base API URL - defaults to localhost for development
// In production (when served from a non-localhost domain), uses relative URLs to avoid CORS issues
const API_BASE_URL = import.meta.env.PUBLIC_API_URL ||
  (typeof window !== 'undefined' && window.location.hostname !== 'localhost'
    ? '' // Use relative URLs in production
    : 'http://localhost:8080'); // Use localhost in development

/**
 * Create axios instance with base configuration.
 * Authentication is handled via the HttpOnly secman_auth cookie,
 * sent automatically with withCredentials: true (set globally in csrf.ts).
 */
const apiClient = axios.create({
  baseURL: API_BASE_URL,
  headers: {
    'Content-Type': 'application/json',
  },
});

// TypeScript interfaces for API responses

/**
 * Most common vulnerability DTO
 * Matches backend: com.secman.dto.MostCommonVulnerabilityDto
 */
export interface MostCommonVulnerabilityDto {
  vulnerabilityId: string;       // CVE identifier
  cvssSeverity: string;          // CRITICAL, HIGH, MEDIUM, LOW, UNKNOWN
  occurrenceCount: number;       // Total occurrences across assets
  affectedAssetCount: number;    // Number of distinct assets affected
}

/**
 * Most vulnerable product DTO
 * Matches backend: com.secman.dto.MostVulnerableProductDto
 */
export interface MostVulnerableProductDto {
  product: string;               // Product name/version
  vulnerabilityCount: number;    // Number of distinct CVEs
  affectedAssetCount: number;    // Number of assets with this product
  criticalCount: number;         // Count of CRITICAL vulnerabilities
  highCount: number;             // Count of HIGH vulnerabilities
}

/**
 * Severity distribution DTO
 * Matches backend: com.secman.dto.SeverityDistributionDto
 */
export interface SeverityDistributionDto {
  critical: number;              // Count of CRITICAL vulnerabilities
  high: number;                  // Count of HIGH vulnerabilities
  medium: number;                // Count of MEDIUM vulnerabilities
  low: number;                   // Count of LOW vulnerabilities
  unknown: number;               // Count of UNKNOWN vulnerabilities
  total: number;                 // Total vulnerability count
  criticalPercentage: number;    // Percentage of CRITICAL (0-100)
  highPercentage: number;        // Percentage of HIGH (0-100)
  mediumPercentage: number;      // Percentage of MEDIUM (0-100)
  lowPercentage: number;         // Percentage of LOW (0-100)
  unknownPercentage: number;     // Percentage of UNKNOWN (0-100)
}

/**
 * Top asset by vulnerabilities DTO
 * Matches backend: com.secman.dto.TopAssetByVulnerabilitiesDto
 */
export interface TopAssetByVulnerabilitiesDto {
  assetId: number;               // Asset ID for navigation
  assetName: string;             // Asset name
  assetType: string | null;      // Asset type (may be null)
  assetIp: string | null;        // Asset IP (may be null)
  totalVulnerabilityCount: number; // Total vulnerability count
  criticalCount: number;         // Count of CRITICAL vulnerabilities
  highCount: number;             // Count of HIGH vulnerabilities
  mediumCount: number;           // Count of MEDIUM vulnerabilities
  lowCount: number;              // Count of LOW vulnerabilities
}

/**
 * Vulnerability by asset type DTO
 * Matches backend: com.secman.dto.VulnerabilityByAssetTypeDto
 */
export interface VulnerabilityByAssetTypeDto {
  assetType: string;             // Asset type (or "Unknown")
  assetCount: number;            // Number of distinct assets
  totalVulnerabilityCount: number; // Total vulnerability count
  criticalCount: number;         // Count of CRITICAL vulnerabilities
  highCount: number;             // Count of HIGH vulnerabilities
  mediumCount: number;           // Count of MEDIUM vulnerabilities
  lowCount: number;              // Count of LOW vulnerabilities
  averageVulnerabilitiesPerAsset: number; // Average vulns per asset
}

/**
 * Temporal trend data point DTO
 * Matches backend: com.secman.dto.TemporalTrendDataPointDto
 */
export interface TemporalTrendDataPointDto {
  date: string;                  // Date in YYYY-MM-DD format
  totalCount: number;            // Total vulnerability count
  criticalCount: number;         // Count of CRITICAL vulnerabilities
  highCount: number;             // Count of HIGH vulnerabilities
  mediumCount: number;           // Count of MEDIUM vulnerabilities
  lowCount: number;              // Count of LOW vulnerabilities
}

/**
 * Temporal trends DTO
 * Matches backend: com.secman.dto.TemporalTrendsDto
 */
export interface TemporalTrendsDto {
  startDate: string;             // Start date (YYYY-MM-DD)
  endDate: string;               // End date (YYYY-MM-DD)
  days: number;                  // Number of days (30, 60, or 90)
  dataPoints: TemporalTrendDataPointDto[]; // Daily data points
}

/**
 * Affected asset DTO
 * Used in CVE drilldown to show which systems are affected
 */
export interface AffectedAssetDto {
  assetId: number;
  assetName: string;
  assetIp: string | null;
  adDomain: string | null;
  assetType: string | null;
}

/**
 * Affected assets by CVE response DTO
 */
export interface AffectedAssetsByCveDto {
  cveId: string;
  severity: string;
  affectedAssets: AffectedAssetDto[];
  totalCount: number;
}

/**
 * Asset with product DTO
 * Used in product drilldown to show which systems have a product installed
 */
export interface AssetWithProductDto {
  assetId: number;
  assetName: string;
  assetIp: string | null;
  adDomain: string | null;
  assetType: string | null;
  vulnerabilityCount: number;
}

/**
 * Assets by product response DTO
 */
export interface AssetsByProductDto {
  product: string;
  assets: AssetWithProductDto[];
  totalCount: number;
}

/**
 * Available domains DTO
 * Matches backend: com.secman.dto.AvailableDomainsDto
 *
 * Feature: 059-vuln-stats-domain-filter
 * Task: T009 [US1]
 */
export interface AvailableDomainsDto {
  domains: string[];             // Sorted list of unique domain names (lowercase)
  totalAssetCount: number;       // Total count of assets with domains
}

/**
 * Vulnerability Statistics API Client
 *
 * Task: T007 (base), T015 (US1 methods)
 * Feature: 059-vuln-stats-domain-filter (domain filter support)
 */
class VulnerabilityStatisticsApi {

  /**
   * Get available domains for filtering
   *
   * Feature: 059-vuln-stats-domain-filter
   * Task: T009 [US1]
   * Endpoint: GET /api/vulnerability-statistics/available-domains
   *
   * @returns Promise resolving to available domains with asset count
   * @throws Error if request fails or user is not authenticated
   */
  async getAvailableDomains(): Promise<AvailableDomainsDto> {
    const response = await apiClient.get<AvailableDomainsDto>(
      '/api/vulnerability-statistics/available-domains',
      {}
    );
    return response.data;
  }

  /**
   * Get most common vulnerabilities (top 10 by occurrence)
   *
   * Feature: 036-vuln-stats-lense, 059-vuln-stats-domain-filter
   * Task: T015 [US1], T010 (domain filter)
   * Endpoint: GET /api/vulnerability-statistics/most-common
   * User Story: US1 - View Most Common Vulnerabilities (P1)
   *
   * @param domain Optional AD domain filter (case-insensitive)
   * @returns Promise resolving to list of most common vulnerabilities
   * @throws Error if request fails or user is not authenticated
   */
  async getMostCommonVulnerabilities(domain?: string | null): Promise<MostCommonVulnerabilityDto[]> {
    const params = domain ? { domain } : {};
    const response = await apiClient.get<MostCommonVulnerabilityDto[]>(
      '/api/vulnerability-statistics/most-common',
      { params }
    );
    return response.data;
  }

  /**
   * Get most vulnerable products (top 10 by distinct CVE count)
   *
   * Feature: 036-vuln-stats-lense, 059-vuln-stats-domain-filter
   * Task: T010 (domain filter)
   * Endpoint: GET /api/vulnerability-statistics/most-vulnerable-products
   *
   * @param domain Optional AD domain filter (case-insensitive)
   * @returns Promise resolving to list of most vulnerable products
   * @throws Error if request fails or user is not authenticated
   */
  async getMostVulnerableProducts(domain?: string | null): Promise<MostVulnerableProductDto[]> {
    const params = domain ? { domain } : {};
    const response = await apiClient.get<MostVulnerableProductDto[]>(
      '/api/vulnerability-statistics/most-vulnerable-products',
      { params }
    );
    return response.data;
  }

  /**
   * Get severity distribution statistics
   *
   * Feature: 036-vuln-stats-lense, 059-vuln-stats-domain-filter
   * Task: T025 [US2], T010 (domain filter)
   * Endpoint: GET /api/vulnerability-statistics/severity-distribution
   * User Story: US2 - View Severity Distribution (P2)
   *
   * @param domain Optional AD domain filter (case-insensitive)
   * @returns Promise resolving to severity distribution with counts and percentages
   * @throws Error if request fails or user is not authenticated
   */
  async getSeverityDistribution(domain?: string | null): Promise<SeverityDistributionDto> {
    const params = domain ? { domain } : {};
    const response = await apiClient.get<SeverityDistributionDto>(
      '/api/vulnerability-statistics/severity-distribution',
      { params }
    );
    return response.data;
  }

  /**
   * Get top 10 assets ranked by vulnerability count
   *
   * Feature: 036-vuln-stats-lense, 059-vuln-stats-domain-filter
   * Task: T039 [US3]
   * Endpoint: GET /api/vulnerability-statistics/top-assets
   * User Story: US3 - View Asset Vulnerability Statistics (P3)
   *
   * @param domain Optional AD domain filter (case-insensitive)
   * @returns Promise resolving to list of top assets with vulnerability counts
   * @throws Error if request fails or user is not authenticated
   */
  async getTopAssetsByVulnerabilities(domain?: string | null): Promise<TopAssetByVulnerabilitiesDto[]> {
    const params = domain ? { domain } : {};
    const response = await apiClient.get<TopAssetByVulnerabilitiesDto[]>(
      '/api/vulnerability-statistics/top-assets',
      { params }
    );
    return response.data;
  }

  /**
   * Get vulnerability statistics grouped by asset type
   *
   * Feature: 036-vuln-stats-lense
   * Task: T039 [US3]
   * Endpoint: GET /api/vulnerability-statistics/by-asset-type
   * User Story: US3 - View Asset Vulnerability Statistics (P3)
   *
   * @returns Promise resolving to list of asset types with vulnerability statistics
   * @throws Error if request fails or user is not authenticated
   */
  async getVulnerabilitiesByAssetType(): Promise<VulnerabilityByAssetTypeDto[]> {
    const response = await apiClient.get<VulnerabilityByAssetTypeDto[]>(
      '/api/vulnerability-statistics/by-asset-type',
      {}
    );
    return response.data;
  }

  /**
   * Get temporal vulnerability trends
   *
   * Feature: 036-vuln-stats-lense
   * Task: T051 [US4]
   * Endpoint: GET /api/vulnerability-statistics/temporal-trends
   * User Story: US4 - View Temporal Trends (P4)
   *
   * @param days Number of days to analyze (30, 60, or 90)
   * @returns Promise resolving to temporal trends with daily data points
   * @throws Error if request fails, user is not authenticated, or days is invalid
   */
  async getTemporalTrends(days: 30 | 60 | 90 = 30): Promise<TemporalTrendsDto> {
    const response = await apiClient.get<TemporalTrendsDto>(
      '/api/vulnerability-statistics/temporal-trends',
      { params: { days } }
    );
    return response.data;
  }

  /**
   * Get affected assets for a specific CVE
   *
   * Returns list of assets affected by the specified CVE within user's access scope.
   * Used in CVE drilldown modal.
   *
   * @param cveId The CVE identifier (e.g., "CVE-2024-12345")
   * @param domain Optional AD domain filter (case-insensitive)
   * @returns Promise resolving to affected assets with CVE info
   * @throws Error if request fails or user is not authenticated
   */
  async getAffectedAssetsByCve(cveId: string, domain?: string | null): Promise<AffectedAssetsByCveDto> {
    const params = domain ? { domain } : {};
    const response = await apiClient.get<AffectedAssetsByCveDto>(
      `/api/vulnerability-statistics/affected-assets/${encodeURIComponent(cveId)}`,
      { params }
    );
    return response.data;
  }

  /**
   * Get assets that have a specific product installed
   *
   * Returns list of assets with the specified product within user's access scope.
   * Used in product drilldown modal.
   *
   * @param product The product name to search for
   * @param domain Optional AD domain filter (case-insensitive)
   * @returns Promise resolving to assets with the product
   * @throws Error if request fails or user is not authenticated
   */
  async getAssetsByProduct(product: string, domain?: string | null): Promise<AssetsByProductDto> {
    const params = domain ? { domain } : {};
    const response = await apiClient.get<AssetsByProductDto>(
      `/api/vulnerability-statistics/assets-by-product/${encodeURIComponent(product)}`,
      { params }
    );
    return response.data;
  }
}

export const vulnerabilityStatisticsApi = new VulnerabilityStatisticsApi();
export { apiClient };
