/**
 * React wrapper component for Vulnerability Statistics page
 *
 * Manages domain filter state and passes it to all statistics components.
 * This component is used as the main React island in the Astro page.
 *
 * Feature: 059-vuln-stats-domain-filter
 * Task: T015, T016 [US1]
 * Spec reference: spec.md FR-004 (update all components when domain selected)
 * User Story: US1 - Filter Statistics by Domain (P1)
 */

import React, { useState, useEffect } from 'react';
import DomainSelector from './DomainSelector';
import MostCommonVulnerabilities from './MostCommonVulnerabilities';
import MostVulnerableProducts from './MostVulnerableProducts';
import SeverityDistributionChart from './SeverityDistributionChart';

/** Session storage key for domain persistence (per spec) */
const STORAGE_KEY = 'secman.vuln-stats.selectedDomain';

export default function VulnerabilityStatisticsPage() {
  // Domain filter state - lifted to page level for all components
  const [selectedDomain, setSelectedDomain] = useState<string | null>(() => {
    // Initialize from sessionStorage (US2: Persist Domain Selection)
    if (typeof window !== 'undefined') {
      return sessionStorage.getItem(STORAGE_KEY);
    }
    return null;
  });

  // Handle domain change
  const handleDomainChange = (domain: string | null) => {
    setSelectedDomain(domain);
  };

  return (
    <>
      {/* Page Header with Domain Selector */}
      <div className="row mb-4">
        <div className="col-12">
          <div className="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
            <div>
              <h1 className="display-5 mb-1">
                <i className="bi bi-bar-chart-line me-2"></i>
                Vulnerability Statistics Lense
              </h1>
              <p className="text-muted mb-0">
                Comprehensive vulnerability analytics and trends across your accessible assets
              </p>
            </div>
            {/* Domain Selector in header for prominent placement (FR-001) */}
            <DomainSelector
              selectedDomain={selectedDomain}
              onDomainChange={handleDomainChange}
            />
          </div>
        </div>
      </div>

      {/* User Story 1: Most Common Vulnerabilities (P1/MVP) */}
      <div className="row mb-4">
        <div className="col-12">
          <MostCommonVulnerabilities domain={selectedDomain} />
        </div>
      </div>

      {/* Most Vulnerable Products */}
      <div className="row mb-4">
        <div className="col-12">
          <MostVulnerableProducts domain={selectedDomain} />
        </div>
      </div>

      {/* User Story 2: Severity Distribution (P2) */}
      <div className="row mb-4">
        <div className="col-12">
          <SeverityDistributionChart domain={selectedDomain} />
        </div>
      </div>
    </>
  );
}
