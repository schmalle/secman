/**
 * Current Vulnerability Export Utility
 *
 * Client-side Excel generation for Current Vulnerabilities data using ExcelJS
 *
 * Features:
 * - Generates Excel workbook with vulnerability data
 * - Summary sheet with statistics (total, by severity, by exception status)
 * - Severity-based cell coloring (Critical=Red, High=Yellow, Medium=Blue, Low=Green)
 * - Auto-filter enabled for easy filtering in Excel
 * - Frozen header row
 *
 * Related to: Feature 004-i-want-to (VULN Role & Vulnerability Management UI)
 */

import ExcelJS from 'exceljs';
import type { CurrentVulnerability } from '../services/vulnerabilityManagementService';

export interface CurrentVulnerabilityExportOptions {
    exportDate: Date;
    filters?: {
        severity?: string;
        system?: string;
        exceptionStatus?: string;
        product?: string;
        adDomain?: string;
        cloudAccountId?: string;
    };
}

/**
 * Export current vulnerabilities to Excel file
 *
 * @param vulnerabilities List of vulnerabilities to export
 * @param options Export options including filters applied
 * @returns Promise that resolves when file is generated and downloaded
 */
export async function exportCurrentVulnerabilitiesToExcel(
    vulnerabilities: CurrentVulnerability[],
    options: CurrentVulnerabilityExportOptions
): Promise<void> {
    const workbook = new ExcelJS.Workbook();

    // Set workbook properties
    workbook.creator = 'Secman';
    workbook.created = new Date();
    workbook.modified = new Date();
    workbook.lastModifiedBy = 'Secman';

    // Create summary sheet
    const summarySheet = workbook.addWorksheet('Summary');

    // Add summary information
    summarySheet.columns = [
        { header: 'Property', key: 'property', width: 30 },
        { header: 'Value', key: 'value', width: 50 },
    ];

    // Calculate severity counts
    const severityCounts = vulnerabilities.reduce((acc, vuln) => {
        const severity = vuln.cvssSeverity || 'Unknown';
        acc[severity] = (acc[severity] || 0) + 1;
        return acc;
    }, {} as Record<string, number>);

    // Calculate overdue status counts
    const overdueStatusCounts = vulnerabilities.reduce((acc, vuln) => {
        const status = vuln.overdueStatus || 'Unknown';
        acc[status] = (acc[status] || 0) + 1;
        return acc;
    }, {} as Record<string, number>);

    // Calculate exception counts
    const exceptedCount = vulnerabilities.filter(v => v.hasException).length;
    const notExceptedCount = vulnerabilities.length - exceptedCount;

    const summaryRows: { property: string; value: string }[] = [
        { property: 'Export Date', value: options.exportDate.toLocaleString() },
        { property: '', value: '' },
        { property: 'Applied Filters', value: '' },
    ];

    // Add filter info
    const filters = options.filters || {};
    if (filters.severity) {
        summaryRows.push({ property: '  Severity', value: filters.severity });
    }
    if (filters.system) {
        summaryRows.push({ property: '  System', value: filters.system });
    }
    if (filters.exceptionStatus) {
        summaryRows.push({ property: '  Exception Status', value: filters.exceptionStatus });
    }
    if (filters.product) {
        summaryRows.push({ property: '  Product', value: filters.product });
    }
    if (filters.adDomain) {
        summaryRows.push({ property: '  AD Domain', value: filters.adDomain });
    }
    if (filters.cloudAccountId) {
        summaryRows.push({ property: '  AWS Account ID', value: filters.cloudAccountId });
    }

    const hasFilters = Object.values(filters).some(v => v);
    if (!hasFilters) {
        summaryRows.push({ property: '  (No filters applied)', value: '' });
    }

    summaryRows.push(
        { property: '', value: '' },
        { property: 'Vulnerability Summary', value: '' },
        { property: '  Total Vulnerabilities', value: String(vulnerabilities.length) },
        { property: '', value: '' },
        { property: 'By Severity', value: '' },
        { property: '  Critical', value: String(severityCounts['Critical'] || 0) },
        { property: '  High', value: String(severityCounts['High'] || 0) },
        { property: '  Medium', value: String(severityCounts['Medium'] || 0) },
        { property: '  Low', value: String(severityCounts['Low'] || 0) },
        { property: '  Unknown', value: String(severityCounts['Unknown'] || 0) },
        { property: '', value: '' },
        { property: 'By Overdue Status', value: '' },
        { property: '  OVERDUE', value: String(overdueStatusCounts['OVERDUE'] || 0) },
        { property: '  EXCEPTED', value: String(overdueStatusCounts['EXCEPTED'] || 0) },
        { property: '  OK', value: String(overdueStatusCounts['OK'] || 0) },
        { property: '', value: '' },
        { property: 'By Exception Status', value: '' },
        { property: '  Excepted', value: String(exceptedCount) },
        { property: '  Not Excepted', value: String(notExceptedCount) },
    );

    summarySheet.addRows(summaryRows);

    // Style summary sheet header
    summarySheet.getRow(1).font = { bold: true, size: 12, color: { argb: 'FFFFFFFF' } };
    summarySheet.getRow(1).fill = {
        type: 'pattern',
        pattern: 'solid',
        fgColor: { argb: 'FF4472C4' },
    };

    // Create vulnerabilities sheet
    const vulnSheet = workbook.addWorksheet('Vulnerabilities');
    vulnSheet.columns = [
        { header: 'Asset Name', key: 'assetName', width: 30 },
        { header: 'IP Address', key: 'assetIp', width: 15 },
        { header: 'CVE ID', key: 'vulnerabilityId', width: 18 },
        { header: 'Severity', key: 'cvssSeverity', width: 12 },
        { header: 'Product', key: 'vulnerableProductVersions', width: 40 },
        { header: 'Days Open', key: 'daysOpen', width: 12 },
        { header: 'Scan Date', key: 'scanTimestamp', width: 20 },
        { header: 'Overdue Status', key: 'overdueStatus', width: 15 },
        { header: 'Has Exception', key: 'hasException', width: 14 },
        { header: 'Exception Reason', key: 'exceptionReason', width: 35 },
    ];

    // Add vulnerability rows
    vulnerabilities.forEach((vuln) => {
        const row = vulnSheet.addRow({
            assetName: vuln.assetName || '-',
            assetIp: vuln.assetIp || '-',
            vulnerabilityId: vuln.vulnerabilityId || '-',
            cvssSeverity: vuln.cvssSeverity || 'Unknown',
            vulnerableProductVersions: vuln.vulnerableProductVersions || '-',
            daysOpen: vuln.daysOpen || '-',
            scanTimestamp: vuln.scanTimestamp ? new Date(vuln.scanTimestamp).toLocaleString() : '-',
            overdueStatus: vuln.overdueStatus || 'Unknown',
            hasException: vuln.hasException ? 'Yes' : 'No',
            exceptionReason: vuln.exceptionReason || '-',
        });

        // Color-code severity cells
        const severityCell = row.getCell('cvssSeverity');
        const severityColor = getSeverityColor(vuln.cvssSeverity);
        if (severityColor) {
            severityCell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: severityColor.bg },
            };
            severityCell.font = { color: { argb: severityColor.text }, bold: true };
        }

        // Color-code overdue status cells
        const overdueCell = row.getCell('overdueStatus');
        const overdueColor = getOverdueStatusColor(vuln.overdueStatus);
        if (overdueColor) {
            overdueCell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: overdueColor.bg },
            };
            overdueCell.font = { color: { argb: overdueColor.text }, bold: true };
        }

        // Color-code exception cells
        const exceptionCell = row.getCell('hasException');
        if (vuln.hasException) {
            exceptionCell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FF198754' }, // Green
            };
            exceptionCell.font = { color: { argb: 'FFFFFFFF' }, bold: true };
        }
    });

    // Style header row
    styleHeaderRow(vulnSheet, 'FF2C3E50');

    // Add auto-filter
    vulnSheet.autoFilter = {
        from: 'A1',
        to: `J${vulnerabilities.length + 1}`,
    };

    // Freeze header row
    vulnSheet.views = [{ state: 'frozen', ySplit: 1 }];

    // Generate buffer and trigger download
    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], {
        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    });

    // Create filename
    const dateStr = new Date().toISOString().split('T')[0];

    // Create download link
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `CurrentVulnerabilities_${dateStr}.xlsx`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);
}

/**
 * Get color codes for severity level
 */
function getSeverityColor(severity: string | null): { bg: string; text: string } | null {
    const sev = severity?.toLowerCase() || '';
    if (sev.includes('critical')) return { bg: 'FFDC3545', text: 'FFFFFFFF' }; // Red
    if (sev.includes('high')) return { bg: 'FFFFC107', text: 'FF000000' }; // Yellow
    if (sev.includes('medium')) return { bg: 'FF17A2B8', text: 'FFFFFFFF' }; // Blue
    if (sev.includes('low')) return { bg: 'FF28A745', text: 'FFFFFFFF' }; // Green
    return null;
}

/**
 * Get color codes for overdue status
 */
function getOverdueStatusColor(status: string | undefined): { bg: string; text: string } | null {
    if (!status) return null;
    const s = status.toUpperCase();
    if (s === 'OVERDUE') return { bg: 'FFDC3545', text: 'FFFFFFFF' }; // Red
    if (s === 'EXCEPTED') return { bg: 'FF17A2B8', text: 'FFFFFFFF' }; // Blue (shield)
    if (s === 'OK') return { bg: 'FF28A745', text: 'FFFFFFFF' }; // Green
    return null;
}

/**
 * Style the header row of a worksheet
 */
function styleHeaderRow(sheet: ExcelJS.Worksheet, color: string): void {
    const headerRow = sheet.getRow(1);
    headerRow.font = { bold: true, size: 11, color: { argb: 'FFFFFFFF' } };
    headerRow.fill = {
        type: 'pattern',
        pattern: 'solid',
        fgColor: { argb: color },
    };
    headerRow.alignment = { vertical: 'middle', horizontal: 'left' };
    headerRow.height = 22;

    // Add borders
    headerRow.eachCell((cell) => {
        cell.border = {
            top: { style: 'thin' },
            left: { style: 'thin' },
            bottom: { style: 'medium' },
            right: { style: 'thin' },
        };
    });

    // Enable text wrap for all cells
    sheet.eachRow((row, rowNumber) => {
        if (rowNumber > 1) {
            row.eachCell((cell) => {
                cell.alignment = { ...cell.alignment, wrapText: true, vertical: 'top' };
                cell.border = {
                    top: { style: 'thin', color: { argb: 'FFE0E0E0' } },
                    left: { style: 'thin', color: { argb: 'FFE0E0E0' } },
                    bottom: { style: 'thin', color: { argb: 'FFE0E0E0' } },
                    right: { style: 'thin', color: { argb: 'FFE0E0E0' } },
                };
            });
        }
    });
}
