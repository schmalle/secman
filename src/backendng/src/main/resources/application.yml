micronaut:
  application:
    name: secman-backend-ng
  executors:
    email:
      type: scheduled
      core-pool-size: 2
      maximum-pool-size: 5
  server:
    port: 8080
    max-request-size: 100MB  # Increased from 20MB for large vulnerability batch imports
    multipart:
      max-file-size: 100MB   # Increased from 20MB for large file uploads
      disk: true
    cors:
      enabled: true
      configurations:
        web:
          allowed-origins:
            - "http://localhost:4321"
            - "http://localhost:3000" 
          allowed-methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
          allowed-headers:
            - Content-Type
            - Authorization
            - Accept
            - Origin
            - Csrf-Token
          exposed-headers:
            - Authorization
          allow-credentials: true
          max-age: 3600
  security:
    authentication: bearer
    token:
      jwt:
        signatures:
          secret:
            generator:
              secret: ${JWT_SECRET:pleasechangethissecrectokeyproductionforsecurityreasonsmustbe256bits}
        generator:
          access-token:
            expiration: 28800  # 8 hours - extended for workday coverage
        claims-validators:
          issuer: secman-backend-ng
    oauth2:
      enabled: true
    intercept-url-map:
      - pattern: /api/auth/login
        access:
          - isAnonymous()
      - pattern: /api/identity-providers/enabled
        access:
          - isAnonymous()
      - pattern: /oauth/**
        access:
          - isAnonymous()
      - pattern: /health
        access:
          - isAnonymous()
      - pattern: /api/auth/status
        access:
          - isAuthenticated()
      - pattern: "/api/**"
        http-method: OPTIONS
        access:
          - isAnonymous()
      - pattern: "/api/**"
        access:
          - isAuthenticated()
  # Cache configuration
  # Feature: 041-falcon-instance-lookup
  # Task: T034
  # Feature: Database Structure Optimization - Extended caching
  caches:
    vulnerability_queries:
      maximum-size: 1000
      expire-after-write: 15m
    # Database optimization caches (Feature: Database Structure Optimization)
    asset_queries:
      maximum-size: 500
      expire-after-write: 10m
    active_exceptions:
      maximum-size: 100
      expire-after-write: 5m
    workgroup_memberships:
      maximum-size: 200
      expire-after-write: 10m
    # MCP Access Control cache (Feature: 052-mcp-access-control)
    mcp_accessible_assets:
      maximum-size: 500
      expire-after-write: 5m

# Email functionality configuration
secman:
  encryption:
    # Encryption password for sensitive data - MUST be overridden in production
    password: ${SECMAN_ENCRYPTION_PASSWORD:SecManDefaultEncryptionPassword2024}
    # Encryption salt - MUST be overridden in production
    salt: ${SECMAN_ENCRYPTION_SALT:5c0744940b5c369b}
  email:
    # SMTP configuration is stored in the database (email_config table)
    # and managed via ADMIN UI. The following settings apply to all email operations.

    # SMTP server settings (override via environment or database)
    smtp-host: ${SMTP_HOST:smtp.example.com}
    smtp-port: ${SMTP_PORT:587}
    username: ${SMTP_USERNAME:noreply@secman.example.com}
    password: ${SMTP_PASSWORD:changeme}
    from-address: ${SMTP_FROM_ADDRESS:noreply@secman.example.com}
    from-name: ${SMTP_FROM_NAME:Security Management System}
    enable-tls: ${SMTP_ENABLE_TLS:true}

    # Email delivery configuration (Feature 035: Notification System)
    retry:
      max-retries: 3              # Number of retry attempts on failure
      delay-between-retries-ms: 1000  # 1 second delay between retries
    # Email performance settings
    performance:
      connection-timeout-ms: 10000  # 10 seconds
      read-timeout-ms: 30000        # 30 seconds
    # Notification settings
    notifications:
      batch-size: 50
      async-processing: true
  # MCP User Delegation Feature (Feature 050)
  mcp:
    delegation:
      alert:
        # Number of failed delegation attempts to trigger alert
        threshold: ${MCP_DELEGATION_ALERT_THRESHOLD:10}
        # Time window in minutes for threshold calculation
        window-minutes: ${MCP_DELEGATION_ALERT_WINDOW:5}
  vulnerability:
    # Use patch publication date for calculating days open
    # When true: days_open = scan_timestamp - patch_publication_date
    # When false: days_open = current_time - detection_time (current behavior)
    use-patch-publication-date: ${VULN_USE_PATCH_PUBLICATION_DATE:false}
    # Filter to import only vulnerabilities with patch publication date set
    # When true: vulnerabilities without patch_publication_date are skipped during import
    # When false: all vulnerabilities are imported (current behavior)
    require-patch-publication-date: ${VULN_REQUIRE_PATCH_PUBLICATION_DATE:false}
  http:
    services:
      translation:
        url: https://openrouter.ai/api/v1
      crowdstrike:
        # Base URLs by region (credentials loaded from falcon_configs table)
        base-urls:
          us-1: https://api.crowdstrike.com
          us-2: https://api.us-2.crowdstrike.com
          eu-1: https://api.eu-1.crowdstrike.com
          us-gov-1: https://api.laggar.gcw.crowdstrike.com
          us-gov-2: https://api.laggar.gcw.crowdstrike.com
        timeout:
          query: 10s  # Query timeout (SC-001: < 10 seconds)
          auth: 5s    # Authentication timeout
        retry:
          max-attempts: 3
          initial-delay: 1000  # 1 second
          max-delay: 4000      # 4 seconds (exponential backoff for 429)
          backoff-multiplier: 2.0
        token:
          cache-duration: 1800  # 30 minutes (1800 seconds)
    client:
      read-timeout: 30s
      connect-timeout: 10s
      max-content-length: 104857600  # 100MB (aligns with max-request-size)
      translation:
        read-timeout: 30s
        connect-timeout: 10s
      crowdstrike:
        read-timeout: 10s
        connect-timeout: 5s
        max-content-length: 10485760  # 10MB for large result sets
      
oauth:
  http-client:
    url: https://api.github.com

datasources:
  default:
    url: ${DB_CONNECT:jdbc:mariadb://localhost:3306/secman}
    driverClassName: org.mariadb.jdbc.Driver
    username: ${DB_USERNAME:secman}
    password: ${DB_PASSWORD:CHANGEME}
    # Connection pool configuration (Feature: Database Structure Optimization)
    maximum-pool-size: 20          # Maximum number of connections in the pool
    minimum-idle: 5                # Minimum number of idle connections
    connection-timeout: 30000      # 30 seconds - timeout for acquiring connection
    idle-timeout: 1800000          # 30 minutes - extended to match session duration
    max-lifetime: 7200000          # 2 hours - extended for long sessions
    leak-detection-threshold: 60000 # 60 seconds - detect connection leaks
    # Connection validation to prevent stale connections
    connection-test-query: SELECT 1
    validation-timeout: 5000       # 5 seconds - timeout for connection validation

jpa:
  default:
    properties:
      hibernate:
        hbm2ddl:
          auto: update
        show_sql: false
        format_sql: true
        # Query optimization settings (Feature: Database Structure Optimization)
        query:
          plan_cache_max_size: 2048                    # Cache compiled query plans
          plan_parameter_metadata_max_size: 128        # Cache query parameter metadata
        jdbc:
          batch_size: 20                               # Batch INSERT/UPDATE statements
          fetch_size: 50                               # JDBC fetch size for result sets
        order_inserts: true                            # Order INSERT statements for batching
        order_updates: true                            # Order UPDATE statements for batching
        # Second-level cache (disabled by default, enable if needed)
        cache:
          use_second_level_cache: false
          use_query_cache: false

jackson:
  dateFormat: yyyy-MM-dd'T'HH:mm:ss.SSSZ
  serialization:
    writeDatesAsTimestamps: false

logger:
  levels:
    com.secman: DEBUG
    io.micronaut.security: DEBUG
    org.hibernate.orm.incubating: ERROR

app:
  backend:
    base-url: ${BACKEND_BASE_URL:https://secman.covestro.net}
  frontend:
    base-url: ${FRONTEND_URL:http://localhost:4321}
