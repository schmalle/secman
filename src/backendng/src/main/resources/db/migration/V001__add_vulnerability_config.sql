-- Migration: Add vulnerability_config table
-- Feature: 021-vulnerability-overdue-exception-logic
-- Date: 2025-10-15
-- Description: Creates configuration table for vulnerability overdue tracking
-- Note: With hibernate.hbm2ddl.auto=update, this will be created automatically.
--       This script is provided for reference and manual execution if needed.

-- Create vulnerability_config table
CREATE TABLE IF NOT EXISTS vulnerability_config (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    reminder_one_days INT NOT NULL DEFAULT 30,
    updated_by VARCHAR(255),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    -- Ensure reminder_one_days is within valid range
    CONSTRAINT chk_reminder_days CHECK (reminder_one_days BETWEEN 1 AND 365)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Insert default configuration (30-day threshold)
-- Use INSERT IGNORE to avoid error if record already exists
INSERT IGNORE INTO vulnerability_config (id, reminder_one_days) VALUES (1, 30);

-- Add index on vulnerability.scan_timestamp for performance
-- This index is critical for efficient overdue status calculation
CREATE INDEX IF NOT EXISTS idx_vulnerability_scan_timestamp 
ON vulnerability(scan_timestamp);

-- Add comment to table for documentation
ALTER TABLE vulnerability_config 
COMMENT = 'Global configuration for vulnerability overdue tracking (Feature 021)';
