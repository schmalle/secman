package com.secman.controller

import com.secman.dto.AvailableDomainsDto
import com.secman.dto.MostCommonVulnerabilityDto
import com.secman.dto.MostVulnerableProductDto
import com.secman.service.VulnerabilityStatisticsService
import io.micronaut.http.HttpResponse
import io.micronaut.http.HttpStatus
import io.micronaut.http.MediaType
import io.micronaut.http.annotation.Controller
import io.micronaut.http.annotation.Get
import io.micronaut.http.annotation.Produces
import io.micronaut.http.annotation.QueryValue
import io.micronaut.security.annotation.Secured
import io.micronaut.security.authentication.Authentication
import io.micronaut.security.rules.SecurityRule
import org.slf4j.LoggerFactory

/**
 * REST API controller for vulnerability statistics
 *
 * Provides endpoints for aggregated vulnerability analytics:
 * - Most common vulnerabilities
 * - Severity distribution
 * - Top assets by vulnerability count
 * - Vulnerabilities by asset type
 * - Temporal trends
 *
 * Access Control: All endpoints require authentication (ADMIN or VULN role)
 * Statistics are filtered by workgroup for non-ADMIN users
 *
 * Feature: 036-vuln-stats-lense
 * Task: T005
 * Spec reference: spec.md Section "API Endpoints"
 * Contract: contracts/vulnerability-statistics-api.yaml
 */
@Controller("/api/vulnerability-statistics")
@Secured(SecurityRule.IS_AUTHENTICATED)
class VulnerabilityStatisticsController(
    private val vulnerabilityStatisticsService: VulnerabilityStatisticsService
) {
    private val logger = LoggerFactory.getLogger(VulnerabilityStatisticsController::class.java)

    /**
     * GET /api/vulnerability-statistics/available-domains
     *
     * Returns list of unique AD domains from assets the user has access to.
     * Used to populate the domain selector dropdown.
     *
     * Feature: 059-vuln-stats-domain-filter
     * Task: T003
     * Spec reference: spec.md FR-002
     * Contract: contracts/domain-filter-api.yaml /available-domains
     *
     * @param authentication Current user authentication context (injected by Micronaut Security)
     * @return HTTP 200 with list of available domains, or HTTP 500 on error
     */
    @Get("/available-domains")
    @Produces(MediaType.APPLICATION_JSON)
    fun getAvailableDomains(authentication: Authentication): HttpResponse<AvailableDomainsDto> {
        return try {
            val result = vulnerabilityStatisticsService.getAvailableDomains(authentication)
            HttpResponse.ok(result)
        } catch (e: Exception) {
            logger.error("Error fetching available domains", e)
            HttpResponse.serverError()
        }
    }

    /**
     * GET /api/vulnerability-statistics/most-common
     *
     * Returns top 10 most frequently occurring vulnerabilities across accessible assets.
     * Optionally filter by AD domain. Respects workgroup-based access control.
     *
     * Feature: 036-vuln-stats-lense, 059-vuln-stats-domain-filter
     * Task: T014 [US1], T007 (domain filter)
     * Spec reference: spec.md FR-001, FR-002
     * User Story: US1 - View Most Common Vulnerabilities (P1)
     * Contract: contracts/domain-filter-api.yaml /most-common
     *
     * @param authentication Current user authentication context (injected by Micronaut Security)
     * @param domain Optional AD domain filter (case-insensitive). If omitted, returns data for all accessible domains.
     * @return HTTP 200 with list of most common vulnerabilities, or HTTP 500 on error
     */
    @Get("/most-common")
    @Produces(MediaType.APPLICATION_JSON)
    fun getMostCommonVulnerabilities(
        authentication: Authentication,
        @QueryValue domain: String?
    ): HttpResponse<List<MostCommonVulnerabilityDto>> {
        return try {
            val result = vulnerabilityStatisticsService.getMostCommonVulnerabilities(authentication, domain)
            HttpResponse.ok(result)
        } catch (e: Exception) {
            logger.error("Error fetching most common vulnerabilities", e)
            HttpResponse.serverError()
        }
    }

    /**
     * GET /api/vulnerability-statistics/most-vulnerable-products
     *
     * Returns top 10 products ranked by distinct vulnerability count across accessible assets.
     * Optionally filter by AD domain. Respects workgroup-based access control.
     *
     * Feature: 036-vuln-stats-lense, 059-vuln-stats-domain-filter
     * Task: T007 (domain filter)
     * Contract: contracts/domain-filter-api.yaml /most-vulnerable-products
     *
     * @param authentication Current user authentication context (injected by Micronaut Security)
     * @param domain Optional AD domain filter (case-insensitive). If omitted, returns data for all accessible domains.
     * @return HTTP 200 with list of most vulnerable products, or HTTP 500 on error
     */
    @Get("/most-vulnerable-products")
    @Produces(MediaType.APPLICATION_JSON)
    fun getMostVulnerableProducts(
        authentication: Authentication,
        @QueryValue domain: String?
    ): HttpResponse<List<MostVulnerableProductDto>> {
        return try {
            val result = vulnerabilityStatisticsService.getMostVulnerableProducts(authentication, domain)
            HttpResponse.ok(result)
        } catch (e: Exception) {
            logger.error("Error fetching most vulnerable products", e)
            HttpResponse.serverError()
        }
    }

    /**
     * GET /api/vulnerability-statistics/severity-distribution
     *
     * Returns vulnerability counts grouped by CVSS severity level (CRITICAL, HIGH, MEDIUM, LOW, UNKNOWN).
     * Includes computed percentage properties for visualization in pie charts.
     * Optionally filter by AD domain. Respects workgroup-based access control.
     *
     * Feature: 036-vuln-stats-lense, 059-vuln-stats-domain-filter
     * Task: T024 [US2], T007 (domain filter)
     * Spec reference: spec.md FR-003, FR-004
     * User Story: US2 - View Severity Distribution (P2)
     * Contract: contracts/domain-filter-api.yaml /severity-distribution
     *
     * @param authentication Current user authentication context (injected by Micronaut Security)
     * @param domain Optional AD domain filter (case-insensitive). If omitted, returns data for all accessible domains.
     * @return HTTP 200 with severity distribution DTO, or HTTP 500 on error
     */
    @Get("/severity-distribution")
    @Produces(MediaType.APPLICATION_JSON)
    fun getSeverityDistribution(
        authentication: Authentication,
        @QueryValue domain: String?
    ): HttpResponse<com.secman.dto.SeverityDistributionDto> {
        return try {
            val result = vulnerabilityStatisticsService.getSeverityDistribution(authentication, domain)
            HttpResponse.ok(result)
        } catch (e: Exception) {
            logger.error("Error fetching severity distribution", e)
            HttpResponse.serverError()
        }
    }

    /**
     * GET /api/vulnerability-statistics/top-assets
     *
     * Returns top 10 assets ranked by total vulnerability count with severity breakdowns.
     * Useful for identifying which assets require the most urgent remediation attention.
     * Respects workgroup-based access control.
     *
     * Feature: 036-vuln-stats-lense
     * Task: T034 [US3]
     * Spec reference: spec.md FR-005, FR-006
     * User Story: US3 - View Asset Vulnerability Statistics (P3)
     * Contract: contracts/vulnerability-statistics-api.yaml /top-assets
     *
     * @param authentication Current user authentication context (injected by Micronaut Security)
     * @return HTTP 200 with list of top assets, or HTTP 500 on error
     */
    @Get("/top-assets")
    @Produces(MediaType.APPLICATION_JSON)
    fun getTopAssetsByVulnerabilities(authentication: Authentication): HttpResponse<List<com.secman.dto.TopAssetByVulnerabilitiesDto>> {
        return try {
            val result = vulnerabilityStatisticsService.getTopAssetsByVulnerabilities(authentication)
            HttpResponse.ok(result)
        } catch (e: Exception) {
            logger.error("Error fetching top assets by vulnerabilities", e)
            HttpResponse.serverError()
        }
    }

    /**
     * GET /api/vulnerability-statistics/by-asset-type
     *
     * Returns vulnerability statistics grouped by asset type (Server, Workstation, Network Device, etc.).
     * Includes severity breakdowns and average vulnerabilities per asset for each type.
     * Useful for identifying systemic vulnerability patterns across infrastructure categories.
     * Respects workgroup-based access control.
     *
     * Feature: 036-vuln-stats-lense
     * Task: T038 [US3]
     * Spec reference: spec.md FR-007, FR-008
     * User Story: US3 - View Asset Vulnerability Statistics (P3)
     * Contract: contracts/vulnerability-statistics-api.yaml /by-asset-type
     *
     * @param authentication Current user authentication context (injected by Micronaut Security)
     * @return HTTP 200 with list of asset type statistics, or HTTP 500 on error
     */
    @Get("/by-asset-type")
    @Produces(MediaType.APPLICATION_JSON)
    fun getVulnerabilitiesByAssetType(authentication: Authentication): HttpResponse<List<com.secman.dto.VulnerabilityByAssetTypeDto>> {
        return try {
            val result = vulnerabilityStatisticsService.getVulnerabilitiesByAssetType(authentication)
            HttpResponse.ok(result)
        } catch (e: Exception) {
            logger.error("Error fetching vulnerabilities by asset type", e)
            HttpResponse.serverError()
        }
    }

    /**
     * GET /api/vulnerability-statistics/temporal-trends
     *
     * Returns time-series vulnerability data showing daily counts over specified period (30, 60, or 90 days).
     * Includes severity breakdowns for trend visualization in line charts.
     * Respects workgroup-based access control.
     *
     * Feature: 036-vuln-stats-lense
     * Task: T050 [US4]
     * Spec reference: spec.md FR-009, FR-010, FR-011
     * User Story: US4 - View Temporal Trends (P4)
     * Contract: contracts/vulnerability-statistics-api.yaml /temporal-trends
     *
     * @param authentication Current user authentication context (injected by Micronaut Security)
     * @param days Number of days to analyze (must be 30, 60, or 90)
     * @return HTTP 200 with temporal trends DTO, HTTP 400 for invalid days parameter, or HTTP 500 on error
     */
    @Get("/temporal-trends")
    @Produces(MediaType.APPLICATION_JSON)
    fun getTemporalTrends(
        authentication: Authentication,
        @QueryValue(defaultValue = "30") days: Int
    ): HttpResponse<*> {
        return try {
            // Validate days parameter
            if (days !in listOf(30, 60, 90)) {
                return HttpResponse.status<String>(HttpStatus.BAD_REQUEST)
                    .body("Days parameter must be 30, 60, or 90")
            }

            val result = vulnerabilityStatisticsService.getTemporalTrends(authentication, days)
            HttpResponse.ok(result)
        } catch (e: IllegalArgumentException) {
            HttpResponse.status<String>(HttpStatus.BAD_REQUEST).body(e.message)
        } catch (e: Exception) {
            logger.error("Error fetching temporal trends", e)
            HttpResponse.serverError<String>()
        }
    }
}
