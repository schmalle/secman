package com.secman.controller

import com.secman.service.VulnerabilityDeduplicationService
import io.micronaut.http.HttpResponse
import io.micronaut.http.HttpStatus
import io.micronaut.http.annotation.Controller
import io.micronaut.http.annotation.Post
import io.micronaut.scheduling.TaskExecutors
import io.micronaut.scheduling.annotation.ExecuteOn
import io.micronaut.security.annotation.Secured
import io.micronaut.security.authentication.Authentication
import org.slf4j.LoggerFactory

/**
 * REST controller for vulnerability maintenance operations
 *
 * Endpoints:
 * - POST /api/vulnerabilities/deduplicate - Remove duplicate vulnerability records (ADMIN only)
 */
@Controller("/api/vulnerabilities")
@Secured("ADMIN")
@ExecuteOn(TaskExecutors.BLOCKING)
open class VulnerabilityMaintenanceController(
    private val deduplicationService: VulnerabilityDeduplicationService
) {
    private val log = LoggerFactory.getLogger(VulnerabilityMaintenanceController::class.java)

    /**
     * Deduplicate vulnerability records across all assets.
     *
     * For each asset, removes duplicate entries where the same
     * (vulnerability_id, vulnerable_product_versions) tuple appears more than once.
     * The oldest record (lowest primary key) is kept for each duplicate group.
     *
     * Security: ADMIN role required
     *
     * @param authentication Current authenticated user
     * @return Deduplication statistics
     */
    @Post("/deduplicate")
    open fun deduplicateVulnerabilities(authentication: Authentication): HttpResponse<*> {
        val username = authentication.name
        log.info("Vulnerability deduplication requested by user={}", username)

        return try {
            val result = deduplicationService.deduplicateAll()

            log.info("Deduplication completed: removed={}, assetsAffected={}, user={}",
                result.totalDuplicatesRemoved, result.assetsAffected, username)

            HttpResponse.ok(result)
        } catch (e: Exception) {
            log.error("Deduplication failed: user={}, exception={}, message={}",
                username, e.javaClass.name, e.message, e)
            HttpResponse.status<Map<String, String>>(HttpStatus.INTERNAL_SERVER_ERROR)
                .body(mapOf("error" to "Deduplication failed: ${e.message}"))
        }
    }
}
