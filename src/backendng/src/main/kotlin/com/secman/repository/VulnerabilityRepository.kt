package com.secman.repository

import com.secman.domain.Vulnerability
import io.micronaut.data.annotation.Repository
import io.micronaut.data.jpa.repository.JpaRepository
import io.micronaut.data.model.Page
import io.micronaut.data.model.Pageable
import io.micronaut.data.model.Sort
import java.time.LocalDateTime

/**
 * Repository for Vulnerability entity operations
 *
 * Related to: Feature 003-i-want-to (Vulnerability Management System)
 */
@Repository
interface VulnerabilityRepository : JpaRepository<Vulnerability, Long> {

    /**
     * Find all vulnerabilities for a specific asset with pagination support
     *
     * @param assetId The asset ID
     * @param pageable Pagination parameters
     * @return Page of vulnerabilities
     */
    fun findByAssetId(assetId: Long, pageable: Pageable): Page<Vulnerability>

    /**
     * Find vulnerabilities for an asset within a date range
     *
     * @param assetId The asset ID
     * @param startDate Start of scan timestamp range
     * @param endDate End of scan timestamp range
     * @param sort Sort order
     * @return List of vulnerabilities
     */
    fun findByAssetIdAndScanTimestampBetween(
        assetId: Long,
        startDate: LocalDateTime,
        endDate: LocalDateTime,
        sort: Sort
    ): List<Vulnerability>

    /**
     * Count vulnerabilities for a specific asset
     *
     * @param assetId The asset ID
     * @return Count of vulnerabilities
     */
    fun countByAssetId(assetId: Long): Long

    // MCP Tool Support - Feature 006: Vulnerability queries with filtering

    /**
     * Find vulnerabilities by CVE ID (partial match, case-insensitive) with pagination
     * Used for: MCP get_vulnerabilities tool - searching by CVE identifier
     * Related to: Feature 006 (MCP Tools for Security Data)
     */
    fun findByVulnerabilityIdContainingIgnoreCase(cveId: String, pageable: Pageable): Page<Vulnerability>

    /**
     * Find vulnerabilities by exact CVSS severity with pagination
     * Used for: MCP get_vulnerabilities tool - filtering by single severity level
     * Related to: Feature 006 (MCP Tools for Security Data)
     */
    fun findByCvssSeverity(severity: String, pageable: Pageable): Page<Vulnerability>

    /**
     * Find vulnerabilities by CVSS severity (multiple values) with pagination
     * Used for: MCP get_vulnerabilities tool - filtering by severity array (e.g., ["Critical", "High"])
     * Related to: Feature 006 (MCP Tools for Security Data)
     */
    fun findByCvssSeverityIn(severities: List<String>, pageable: Pageable): Page<Vulnerability>

    /**
     * Find vulnerabilities within a scan timestamp range with pagination
     * Used for: MCP get_vulnerabilities tool - date range filtering
     * Related to: Feature 006 (MCP Tools for Security Data)
     */
    fun findByScanTimestampBetween(start: LocalDateTime, end: LocalDateTime, pageable: Pageable): Page<Vulnerability>
}
