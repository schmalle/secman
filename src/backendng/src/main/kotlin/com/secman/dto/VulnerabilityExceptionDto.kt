package com.secman.dto

import com.fasterxml.jackson.annotation.JsonIgnore
import com.secman.domain.VulnerabilityException.ExceptionType
import io.micronaut.serde.annotation.Serdeable
import jakarta.validation.constraints.NotBlank
import jakarta.validation.constraints.NotNull
import jakarta.validation.constraints.Size
import java.time.LocalDateTime

/**
 * DTO for VulnerabilityException response
 *
 * Related to: Feature 004-i-want-to (VULN Role & Vulnerability Management UI)
 * Related to: Feature 021-vulnerability-overdue-exception-logic (Added assetId, assetName)
 */
@Serdeable
data class VulnerabilityExceptionDto(
    val id: Long?,
    val exceptionType: ExceptionType,
    val targetValue: String,
    val expirationDate: LocalDateTime?,
    val reason: String,
    val createdBy: String,
    val createdAt: LocalDateTime?,
    val updatedAt: LocalDateTime?,
    val isActive: Boolean,
    val affectedVulnerabilityCount: Int? = null,  // Optional: for Exceptions list view
    // Feature 021: Asset exception fields
    val assetId: Long? = null,  // Asset ID for ASSET-type exceptions
    val assetName: String? = null  // Asset name for display (populated if available)
)

/**
 * Request DTO for creating a new VulnerabilityException
 *
 * Related to: Feature 004-i-want-to (VULN Role & Vulnerability Management UI)
 * Related to: Feature 021-vulnerability-overdue-exception-logic (Added assetId)
 */
@Serdeable
data class CreateVulnerabilityExceptionRequest(
    @field:NotNull
    val exceptionType: ExceptionType,

    @field:NotBlank
    @field:Size(max = 1024)
    val targetValue: String,

    val expirationDate: LocalDateTime?,

    @field:NotBlank
    @field:Size(max = 1024)
    val reason: String,
    
    // Feature 021: Asset ID for ASSET-type exceptions
    val assetId: Long? = null
)

/**
 * Request DTO for updating an existing VulnerabilityException
 *
 * Related to: Feature 004-i-want-to (VULN Role & Vulnerability Management UI)
 * Related to: Feature 021-vulnerability-overdue-exception-logic (Added assetId)
 */
@Serdeable
data class UpdateVulnerabilityExceptionRequest(
    @field:NotNull
    val exceptionType: ExceptionType,

    @field:NotBlank
    @field:Size(max = 1024)
    val targetValue: String,

    val expirationDate: LocalDateTime?,

    @field:NotBlank
    @field:Size(max = 1024)
    val reason: String,
    
    // Feature 021: Asset ID for ASSET-type exceptions
    val assetId: Long? = null
)

/**
 * DTO for Vulnerability with exception information and overdue status
 *
 * Note: The `asset` field is excluded from JSON serialization (@JsonIgnore) to reduce
 * API response sizes by ~40%. Use the flat fields (assetId, assetName, assetIp) for display.
 * The asset field is retained for service-layer use (exception matching, etc.).
 *
 * Feature 004: Added exception information
 * Feature 021: Added overdue status tracking
 * Feature 073: Excluded asset from JSON serialization to reduce response size
 *
 * Related to: Feature 021-vulnerability-overdue-exception-logic
 * Related to: Feature 073-memory-optimization
 */
@Serdeable
data class VulnerabilityWithExceptionDto(
    val id: Long?,
    @field:JsonIgnore
    val asset: com.secman.domain.Asset,  // Excluded from JSON - use flat fields for API responses
    val assetId: Long,
    val assetName: String,
    val assetIp: String?,
    val vulnerabilityId: String?,
    val cvssSeverity: String?,
    val vulnerableProductVersions: String?,
    val daysOpen: String?,
    val scanTimestamp: LocalDateTime,
    val hasException: Boolean,  // Indicates if vulnerability is covered by active exception
    val exceptionReason: String? = null,  // Reason for exception (if applicable)
    
    // Feature 021: Overdue status fields
    val ageInDays: Int = 0,  // Age of vulnerability in days since scanTimestamp
    val overdueStatus: OverdueStatus = OverdueStatus.OK,  // Overdue status (OK/OVERDUE/EXCEPTED)
    val daysOverdue: Int? = null,  // Days past the threshold (null if not overdue)
    val exceptionId: Long? = null,  // ID of the exception (if excepted)
    val exceptionEndDate: LocalDateTime? = null  // Exception expiration date (if excepted)
)

/**
 * Paginated response wrapper for vulnerabilities
 *
 * Contains pagination metadata along with the vulnerability data
 */
@Serdeable
data class PaginatedVulnerabilitiesResponse(
    val content: List<VulnerabilityWithExceptionDto>,
    val totalElements: Long,
    val totalPages: Int,
    val currentPage: Int,
    val pageSize: Int,
    val hasNext: Boolean,
    val hasPrevious: Boolean
)
