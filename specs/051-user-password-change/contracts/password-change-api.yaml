openapi: 3.0.3
info:
  title: User Password Change API
  description: |
    API for authenticated users to change their own password.
    Part of Feature 051: User Password Change.
  version: 1.0.0
  contact:
    name: Secman Development Team

servers:
  - url: /api
    description: Relative path (production uses reverse proxy)

security:
  - BearerAuth: []

tags:
  - name: User Profile
    description: User profile and security operations

paths:
  /users/profile/change-password:
    put:
      operationId: changePassword
      summary: Change current user's password
      description: |
        Allows authenticated users with local accounts to change their password.

        **Requirements:**
        - User must be authenticated (valid JWT token)
        - User must have LOCAL authentication source (not OAuth-only)
        - Current password must be correct
        - New password must be at least 8 characters
        - New password must differ from current password
        - New password and confirmation must match

        **Security:**
        - Audit log entry created on success
        - All failed attempts logged for security monitoring
      tags:
        - User Profile
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChangePasswordRequest'
            examples:
              validRequest:
                summary: Valid password change request
                value:
                  currentPassword: "oldPassword123"
                  newPassword: "newSecurePassword456"
                  confirmPassword: "newSecurePassword456"
      responses:
        '200':
          description: Password changed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChangePasswordResponse'
              examples:
                success:
                  summary: Successful password change
                  value:
                    success: true
                    message: "Password changed successfully"
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                wrongPassword:
                  summary: Current password incorrect
                  value:
                    error: "Current password is incorrect"
                mismatch:
                  summary: Passwords don't match
                  value:
                    error: "New password and confirmation do not match"
                tooShort:
                  summary: Password too short
                  value:
                    error: "Password must be at least 8 characters"
                samePassword:
                  summary: Same as current
                  value:
                    error: "New password must be different from current password"
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                notAuthenticated:
                  summary: Missing or invalid token
                  value:
                    error: "Authentication required"
        '403':
          description: OAuth user cannot change password
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                oauthUser:
                  summary: OAuth-only user
                  value:
                    error: "Password change is not available for OAuth accounts"

  /users/profile:
    get:
      operationId: getCurrentUserProfile
      summary: Get current user's profile
      description: |
        Returns the authenticated user's profile information.

        **Updated for Feature 051:**
        - Includes `canChangePassword` field indicating if password change is available
      tags:
        - User Profile
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Profile data retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfileResponse'
              examples:
                localUser:
                  summary: Local user (can change password)
                  value:
                    username: "john.doe"
                    email: "john.doe@example.com"
                    roles: ["USER", "VULN"]
                    canChangePassword: true
                oauthUser:
                  summary: OAuth user (cannot change password)
                  value:
                    username: "jane.smith"
                    email: "jane.smith@example.com"
                    roles: ["USER"]
                    canChangePassword: false
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token from /api/auth/login or OAuth callback

  schemas:
    ChangePasswordRequest:
      type: object
      required:
        - currentPassword
        - newPassword
        - confirmPassword
      properties:
        currentPassword:
          type: string
          format: password
          minLength: 1
          maxLength: 200
          description: User's current password
          example: "currentPassword123"
        newPassword:
          type: string
          format: password
          minLength: 8
          maxLength: 200
          description: Desired new password (minimum 8 characters)
          example: "newSecurePassword456"
        confirmPassword:
          type: string
          format: password
          minLength: 8
          maxLength: 200
          description: Confirmation of new password (must match newPassword)
          example: "newSecurePassword456"

    ChangePasswordResponse:
      type: object
      required:
        - success
        - message
      properties:
        success:
          type: boolean
          description: Indicates if the password change was successful
          example: true
        message:
          type: string
          description: Human-readable result message
          example: "Password changed successfully"

    UserProfileResponse:
      type: object
      required:
        - username
        - email
        - roles
        - canChangePassword
      properties:
        username:
          type: string
          description: User's username
          example: "john.doe"
        email:
          type: string
          format: email
          description: User's email address
          example: "john.doe@example.com"
        roles:
          type: array
          items:
            type: string
            enum: [USER, ADMIN, VULN, RELEASE_MANAGER, REQ, RISK, SECCHAMPION]
          description: User's assigned roles
          example: ["USER", "VULN"]
        canChangePassword:
          type: boolean
          description: |
            Indicates if user can change their password.
            - true: User has local account (LOCAL or HYBRID authSource)
            - false: User authenticated via OAuth only
          example: true

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: Error message describing what went wrong
          example: "Current password is incorrect"
        message:
          type: string
          description: Additional context (optional)
          example: "Please verify your current password and try again"
