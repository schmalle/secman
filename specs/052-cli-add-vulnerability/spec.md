# Feature Specification: CLI Add Vulnerability

**Feature Branch**: `052-cli-add-vulnerability`
**Created**: 2025-12-07
**Status**: Draft
**Input**: User description: "implement a command line function to add a vulnerability for a given hostname, i want to add CVE number, criticality and days open. If a hostname is not yet found, create the asset in secman."

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Add Vulnerability to Existing Asset (Priority: P1)

A security analyst wants to manually add a vulnerability record to an asset that already exists in secman. This is useful for recording vulnerabilities discovered through manual penetration testing, security audits, or external reports that are not automatically imported from CrowdStrike.

**Why this priority**: This is the core functionality - adding vulnerabilities is the primary use case, and most assets will already exist in the system from prior imports.

**Independent Test**: Can be fully tested by running the CLI command with a valid CVE, criticality, days open, and an existing hostname - the vulnerability appears in the asset's vulnerability list.

**Acceptance Scenarios**:

1. **Given** an asset named "webserver01" exists in secman, **When** the user runs `secman add-vulnerability --hostname webserver01 --cve CVE-2024-1234 --criticality HIGH --days-open 30`, **Then** a new vulnerability record is created linked to the asset with the specified CVE, criticality, and days open value
2. **Given** an asset named "dbserver02" exists in secman, **When** the user runs the add-vulnerability command with valid parameters, **Then** the system confirms successful creation and displays the created vulnerability details
3. **Given** an asset exists in secman, **When** the user adds a vulnerability with criticality "CRITICAL", **Then** the vulnerability is stored with cvss_severity set to "Critical"

---

### User Story 2 - Add Vulnerability with Auto-Created Asset (Priority: P2)

A security analyst wants to add a vulnerability for a hostname that does not yet exist in secman. The system should automatically create the asset before linking the vulnerability to it.

**Why this priority**: Asset auto-creation enables complete workflows without requiring separate asset creation steps, making the CLI more user-friendly.

**Independent Test**: Can be fully tested by running the CLI command with a non-existent hostname - the asset is created and the vulnerability is linked to it.

**Acceptance Scenarios**:

1. **Given** no asset named "newserver99" exists in secman, **When** the user runs `secman add-vulnerability --hostname newserver99 --cve CVE-2023-5678 --criticality MEDIUM --days-open 15`, **Then** the system creates a new asset named "newserver99" with default type "SERVER" and owner "CLI-IMPORT", then creates the vulnerability linked to it
2. **Given** no asset with the specified hostname exists, **When** the user runs the add-vulnerability command, **Then** the system displays a message indicating the asset was auto-created before confirming vulnerability creation
3. **Given** no asset exists, **When** the asset is auto-created, **Then** the created_at and last_seen timestamps are set to the current time

---

### User Story 3 - Validation and Error Handling (Priority: P3)

A user attempts to add a vulnerability with invalid or incomplete data. The system should provide clear validation errors.

**Why this priority**: Good error handling improves usability and prevents bad data from entering the system.

**Independent Test**: Can be fully tested by running commands with various invalid inputs and verifying appropriate error messages are displayed.

**Acceptance Scenarios**:

1. **Given** any system state, **When** the user runs the command without a required parameter (hostname, CVE, or criticality), **Then** the system displays a clear error message indicating which parameter is missing
2. **Given** any system state, **When** the user provides an invalid criticality value (not CRITICAL/HIGH/MEDIUM/LOW), **Then** the system displays an error listing valid criticality options
3. **Given** any system state, **When** the user provides a negative days-open value, **Then** the system displays an error that days-open must be a positive number or zero

---

### Edge Cases

- What happens when the CVE already exists for the same asset? System uses upsert pattern - updates existing record with new days-open value
- How does the system handle CVE format validation? Accept any string format for flexibility (manual entries may use non-standard identifiers)
- What happens when database connection fails? Display connection error and exit with non-zero code
- What happens when days-open is 0? Allow it - represents a newly discovered vulnerability

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: System MUST provide a CLI command `add-vulnerability` to create vulnerability records
- **FR-002**: System MUST require `--hostname`, `--cve`, and `--criticality` parameters
- **FR-003**: System MUST support optional `--days-open` parameter (defaults to 0 if not provided)
- **FR-004**: System MUST validate criticality against allowed values: CRITICAL, HIGH, MEDIUM, LOW
- **FR-005**: System MUST look up existing asset by hostname (case-insensitive match)
- **FR-006**: System MUST auto-create asset if hostname not found, with type "SERVER" and owner "CLI-IMPORT"
- **FR-007**: System MUST calculate scan_timestamp from days-open value (current date minus days open)
- **FR-008**: System MUST store the days_open value as text (e.g., "30 days")
- **FR-009**: System MUST require authentication via `--username` and `--password` flags for database write operations
- **FR-010**: System MUST display confirmation message on successful creation including asset name and vulnerability details
- **FR-011**: System MUST exit with non-zero code on validation or database errors
- **FR-012**: System MUST support `--verbose` flag for detailed logging output
- **FR-013**: System MUST support `--backend-url` parameter for specifying the API endpoint (defaults to http://localhost:8080)
- **FR-014**: System MUST use upsert pattern - if vulnerability with same CVE exists for the asset, update the existing record (days-open, scan_timestamp, criticality) instead of creating a duplicate

### Key Entities

- **Asset**: Host/server record - uses existing entity with name, type, owner, lastSeen attributes
- **Vulnerability**: Security vulnerability record - uses existing entity with vulnerabilityId (CVE), cvssSeverity, daysOpen, scanTimestamp, asset relationship

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Users can add a vulnerability to an existing asset in a single command execution
- **SC-002**: Users can add a vulnerability to a new hostname without pre-creating the asset
- **SC-003**: All required parameter validation errors are displayed before any database operations occur
- **SC-004**: Added vulnerabilities appear in the asset's vulnerability list through the web interface and API
- **SC-005**: Command provides clear success/failure feedback with appropriate exit codes

## Clarifications

### Session 2025-12-07

- Q: How should duplicate vulnerabilities (same CVE + same asset) be handled? â†’ A: Overwrite existing entry in database and adapt "days open" (upsert pattern)

## Assumptions

- Authentication will use the existing backend API authentication mechanism (username/password to obtain JWT)
- Asset hostname lookup is case-insensitive (consistent with existing asset matching behavior)
- Auto-created assets use default type "SERVER" as this is the most common use case for manual vulnerability entry
- The CVE field accepts any string format to allow for non-CVE vulnerability identifiers
- Days-open defaults to 0 when not specified, representing a vulnerability just discovered today
