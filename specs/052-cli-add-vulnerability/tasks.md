# Tasks: CLI Add Vulnerability

**Input**: Design documents from `/specs/052-cli-add-vulnerability/`
**Prerequisites**: plan.md, spec.md, research.md, data-model.md, contracts/

**Tests**: Not requested - no test tasks included per constitution (User-Requested Testing principle).

**Organization**: Tasks are grouped by user story to enable independent implementation and testing of each story.

## Format: `[ID] [P?] [Story] Description`

- **[P]**: Can run in parallel (different files, no dependencies)
- **[Story]**: Which user story this task belongs to (e.g., US1, US2, US3)
- Include exact file paths in descriptions

## Path Conventions

- **Backend**: `src/backendng/src/main/kotlin/com/secman/`
- **CLI**: `src/cli/src/main/kotlin/com/secman/cli/`

---

## Phase 1: Setup

**Purpose**: Create DTOs and repository method needed by all user stories

- [x] T001 [P] Create AddVulnerabilityRequestDto in src/backendng/src/main/kotlin/com/secman/dto/AddVulnerabilityRequestDto.kt
- [x] T002 [P] Create AddVulnerabilityResponseDto in src/backendng/src/main/kotlin/com/secman/dto/AddVulnerabilityResponseDto.kt
- [x] T003 Add findByAssetAndVulnerabilityId method to VulnerabilityRepository in src/backendng/src/main/kotlin/com/secman/repository/VulnerabilityRepository.kt

---

## Phase 2: Foundational (Backend API)

**Purpose**: Backend endpoint that MUST be complete before CLI can be tested

**‚ö†Ô∏è CRITICAL**: No CLI implementation can work until this phase is complete

- [x] T004 Add addVulnerabilityFromCli method to VulnerabilityService with upsert logic in src/backendng/src/main/kotlin/com/secman/service/VulnerabilityService.kt
- [x] T005 Add POST /api/vulnerabilities/cli-add endpoint to VulnerabilityManagementController with @Secured(ADMIN, VULN) in src/backendng/src/main/kotlin/com/secman/controller/VulnerabilityManagementController.kt
- [x] T006 Verify backend compiles and endpoint is accessible via ./gradlew :backendng:compileKotlin

**Checkpoint**: Backend API ready - CLI implementation can now begin

---

## Phase 3: User Story 1 - Add Vulnerability to Existing Asset (Priority: P1) üéØ MVP

**Goal**: Security analyst can add a vulnerability record to an existing asset via CLI

**Independent Test**: Run `./gradlew cli:run --args='add-vulnerability --hostname <existing-asset> --cve CVE-2024-1234 --criticality HIGH --days-open 30 --username admin --password secret'` and verify vulnerability appears in asset's vulnerability list

### Implementation for User Story 1

- [x] T007 [P] [US1] Create VulnerabilityCliService with authenticate and addVulnerability methods in src/cli/src/main/kotlin/com/secman/cli/service/VulnerabilityCliService.kt
- [x] T008 [P] [US1] Create AddVulnerabilityCommand Picocli command with required options (--hostname, --cve, --criticality) in src/cli/src/main/kotlin/com/secman/cli/commands/AddVulnerabilityCommand.kt
- [x] T009 [US1] Add optional parameters (--days-open, --verbose, --backend-url) to AddVulnerabilityCommand in src/cli/src/main/kotlin/com/secman/cli/commands/AddVulnerabilityCommand.kt
- [x] T010 [US1] Add add-vulnerability command routing to SecmanCli.kt in src/cli/src/main/kotlin/com/secman/cli/SecmanCli.kt
- [x] T011 [US1] Add success message display showing asset name and vulnerability details in AddVulnerabilityCommand
- [x] T012 [US1] Verify US1 works: compile with ./gradlew :cli:compileKotlin and test with existing asset

**Checkpoint**: User Story 1 complete - can add vulnerabilities to existing assets

---

## Phase 4: User Story 2 - Add Vulnerability with Auto-Created Asset (Priority: P2)

**Goal**: Security analyst can add a vulnerability for a new hostname, with asset auto-created

**Independent Test**: Run CLI with non-existent hostname, verify asset is created with type "SERVER" and owner "CLI-IMPORT", and vulnerability is linked

### Implementation for User Story 2

- [x] T013 [US2] Add asset auto-creation logic (type=SERVER, owner=CLI-IMPORT) to VulnerabilityService.addVulnerabilityFromCli in src/backendng/src/main/kotlin/com/secman/service/VulnerabilityService.kt
- [x] T014 [US2] Add assetCreated indicator to response and display message when asset is auto-created in AddVulnerabilityCommand
- [x] T015 [US2] Verify US2 works: test with non-existent hostname, verify asset created with correct defaults

**Checkpoint**: User Story 2 complete - auto-creates assets when hostname not found

---

## Phase 5: User Story 3 - Validation and Error Handling (Priority: P3)

**Goal**: Clear error messages for invalid input before any database operations

**Independent Test**: Run CLI with missing/invalid parameters, verify appropriate error messages

### Implementation for User Story 3

- [x] T016 [US3] Add Picocli required=true validation for --hostname, --cve, --criticality in AddVulnerabilityCommand
- [x] T017 [US3] Add criticality enum validation (CRITICAL/HIGH/MEDIUM/LOW) with completionCandidates in AddVulnerabilityCommand
- [x] T018 [US3] Add days-open minimum value validation (>=0) in AddVulnerabilityCommand
- [x] T019 [US3] Add authentication error handling with clear message in VulnerabilityCliService
- [x] T020 [US3] Add backend connection error handling with exit code 2 in VulnerabilityCliService
- [x] T021 [US3] Verify US3 works: test with invalid criticality, missing hostname, negative days-open

**Checkpoint**: User Story 3 complete - all validation errors display correctly

---

## Phase 6: Polish & Cross-Cutting Concerns

**Purpose**: Update documentation and verify full integration

- [x] T022 Add add-vulnerability command help text to SecmanCli.showHelp() in src/cli/src/main/kotlin/com/secman/cli/SecmanCli.kt
- [x] T023 Update CLAUDE.md with new CLI command and endpoint in CLAUDE.md
- [x] T024 Verify full build passes: ./gradlew build

---

## Dependencies & Execution Order

### Phase Dependencies

- **Setup (Phase 1)**: No dependencies - can start immediately
- **Foundational (Phase 2)**: Depends on Setup completion - BLOCKS all CLI work
- **User Stories (Phase 3+)**: All depend on Foundational phase completion
  - US1 can start immediately after Phase 2
  - US2 extends US1 (adds auto-creation logic)
  - US3 can be done in parallel with US1/US2 (validation is CLI-side)
- **Polish (Phase 6)**: Depends on all user stories being complete

### User Story Dependencies

- **User Story 1 (P1)**: Can start after Foundational (Phase 2) - Core CLI command
- **User Story 2 (P2)**: Builds on US1 - adds backend auto-creation, minor CLI change
- **User Story 3 (P3)**: Can start after Phase 2 - CLI validation independent of US1/US2

### Within Each Phase

- T001, T002 can run in parallel (different files)
- T007, T008 can run in parallel (different files)
- Services before controller integration
- Backend before CLI (CLI depends on API)

### Parallel Opportunities

- T001, T002 (Phase 1 DTOs)
- T007, T008 (Phase 3 CLI service + command)
- US3 validation tasks can proceed in parallel with US1/US2 implementation

---

## Parallel Example: Phase 1 Setup

```bash
# Launch DTOs in parallel:
Task: "Create AddVulnerabilityRequestDto in src/backendng/src/main/kotlin/com/secman/dto/AddVulnerabilityRequestDto.kt"
Task: "Create AddVulnerabilityResponseDto in src/backendng/src/main/kotlin/com/secman/dto/AddVulnerabilityResponseDto.kt"
```

## Parallel Example: User Story 1 Start

```bash
# Launch CLI service and command in parallel:
Task: "Create VulnerabilityCliService in src/cli/src/main/kotlin/com/secman/cli/service/VulnerabilityCliService.kt"
Task: "Create AddVulnerabilityCommand in src/cli/src/main/kotlin/com/secman/cli/commands/AddVulnerabilityCommand.kt"
```

---

## Implementation Strategy

### MVP First (User Story 1 Only)

1. Complete Phase 1: Setup (DTOs + repository method)
2. Complete Phase 2: Foundational (backend endpoint)
3. Complete Phase 3: User Story 1 (CLI command)
4. **STOP and VALIDATE**: Test with existing asset
5. Deploy/demo if ready

### Incremental Delivery

1. Complete Setup + Foundational ‚Üí Backend API ready
2. Add User Story 1 ‚Üí Basic CLI works ‚Üí **MVP!**
3. Add User Story 2 ‚Üí Auto-creation works
4. Add User Story 3 ‚Üí Validation polished
5. Each story adds value without breaking previous stories

---

## Notes

- [P] tasks = different files, no dependencies
- [Story] label maps task to specific user story for traceability
- Backend must compile before CLI testing
- Commit after each task or logical group
- Stop at any checkpoint to validate story independently
