# Data Model: CLI Add Vulnerability

**Feature**: 052-cli-add-vulnerability
**Date**: 2025-12-07

## Overview

This feature uses existing entities (Asset, Vulnerability) with no schema changes. Only new repository methods are required.

---

## Existing Entities (No Changes)

### Asset

**Location**: `src/backendng/src/main/kotlin/com/secman/domain/Asset.kt`

| Field | Type | Constraints | Notes |
|-------|------|-------------|-------|
| id | Long | PK, auto-generated | |
| name | String | NOT NULL, max 255 | Hostname for matching |
| type | String | NOT NULL | Default "SERVER" for auto-created |
| owner | String | NOT NULL, max 255 | Default "CLI-IMPORT" for auto-created |
| createdAt | LocalDateTime | auto-set | |
| lastSeen | LocalDateTime | nullable | Set to current time |

**Relevant method**: `findByNameIgnoreCase(name: String): Asset?`

---

### Vulnerability

**Location**: `src/backendng/src/main/kotlin/com/secman/domain/Vulnerability.kt`

| Field | Type | Constraints | Notes |
|-------|------|-------------|-------|
| id | Long | PK, auto-generated | |
| asset | Asset | FK, NOT NULL | ManyToOne relationship |
| vulnerabilityId | String | max 255 | CVE identifier |
| cvssSeverity | String | max 50 | "Critical", "High", "Medium", "Low" |
| daysOpen | String | max 50 | Display text, e.g., "30 days" |
| scanTimestamp | LocalDateTime | NOT NULL | Calculated from daysOpen |
| importTimestamp | LocalDateTime | nullable | Set to current time |
| createdAt | LocalDateTime | auto-set | |

---

## New Repository Method

### VulnerabilityRepository

**Location**: `src/backendng/src/main/kotlin/com/secman/repository/VulnerabilityRepository.kt`

**New Method**:
```kotlin
/**
 * Find vulnerability by asset and CVE ID for upsert operation
 * Feature: 052-cli-add-vulnerability (FR-014)
 *
 * @param asset The asset entity
 * @param vulnerabilityId The CVE identifier
 * @return The vulnerability if found, null otherwise
 */
fun findByAssetAndVulnerabilityId(asset: Asset, vulnerabilityId: String): Vulnerability?
```

**Purpose**: Enables upsert pattern - find existing vulnerability to update, or return null for insert.

---

## New DTO

### AddVulnerabilityRequestDto

**Location**: `src/backendng/src/main/kotlin/com/secman/dto/AddVulnerabilityRequestDto.kt`

```kotlin
@Serdeable
data class AddVulnerabilityRequestDto(
    @field:NotBlank
    val hostname: String,

    @field:NotBlank
    val cve: String,

    @field:NotBlank
    @field:Pattern(regexp = "CRITICAL|HIGH|MEDIUM|LOW", message = "Criticality must be CRITICAL, HIGH, MEDIUM, or LOW")
    val criticality: String,

    @field:Min(0)
    val daysOpen: Int = 0
)
```

### AddVulnerabilityResponseDto

**Location**: `src/backendng/src/main/kotlin/com/secman/dto/AddVulnerabilityResponseDto.kt`

```kotlin
@Serdeable
data class AddVulnerabilityResponseDto(
    val success: Boolean,
    val message: String,
    val assetName: String,
    val assetCreated: Boolean,
    val vulnerabilityId: String,
    val operation: String  // "CREATED" or "UPDATED"
)
```

---

## State Transitions

### Vulnerability Lifecycle

```
[CLI Input]
    ↓
[Lookup Asset by hostname]
    ↓
┌─────────────────────────────────────┐
│ Asset exists?                       │
│   YES → use existing asset          │
│   NO  → create new asset            │
└─────────────────────────────────────┘
    ↓
[Lookup Vulnerability by asset+CVE]
    ↓
┌─────────────────────────────────────┐
│ Vulnerability exists?               │
│   YES → UPDATE (daysOpen, severity) │
│   NO  → INSERT new vulnerability    │
└─────────────────────────────────────┘
    ↓
[Return response with operation type]
```

---

## Validation Rules

| Field | Rule | Error Message |
|-------|------|---------------|
| hostname | Required, non-blank | "Hostname is required" |
| cve | Required, non-blank | "CVE is required" |
| criticality | Must be CRITICAL/HIGH/MEDIUM/LOW | "Criticality must be CRITICAL, HIGH, MEDIUM, or LOW" |
| daysOpen | Must be >= 0 | "Days open must be a positive number or zero" |

---

## Index Usage

Existing indexes used by this feature:

| Table | Index | Used By |
|-------|-------|---------|
| asset | idx_asset_name | `findByNameIgnoreCase()` |
| vulnerability | idx_vulnerability_asset_cve | `findByAssetAndVulnerabilityId()` (new method uses existing index) |

No new indexes required.
