# Implementation Plan: CLI Add Vulnerability

**Branch**: `052-cli-add-vulnerability` | **Date**: 2025-12-07 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/052-cli-add-vulnerability/spec.md`

## Summary

Implement a CLI command `add-vulnerability` that allows manual vulnerability entry for a given hostname. The command accepts CVE, criticality, and days-open parameters. If the hostname doesn't exist, create the asset automatically. Uses upsert pattern - if the same CVE already exists for the asset, update it instead of creating a duplicate.

## Technical Context

**Language/Version**: Kotlin 2.2.21 / Java 21
**Primary Dependencies**: Micronaut 4.10, Picocli 4.7, Hibernate JPA
**Storage**: MariaDB 12 (existing Asset, Vulnerability entities)
**Testing**: N/A (per constitution - user-requested only)
**Target Platform**: Linux/macOS CLI (JVM-based)
**Project Type**: CLI module within monorepo
**Performance Goals**: Single command execution < 5 seconds
**Constraints**: Must use existing backend API authentication pattern
**Scale/Scope**: Single vulnerability per invocation

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Security-First | PASS | Uses existing JWT auth; input sanitization via Picocli validation |
| III. API-First | PASS | CLI calls backend REST API `/api/vulnerabilities/cli-add` |
| IV. User-Requested Testing | PASS | No test tasks included (not requested) |
| V. RBAC | PASS | Requires authentication; backend enforces ADMIN or VULN role |
| VI. Schema Evolution | PASS | Uses existing entities; new repository method only |

## Project Structure

### Documentation (this feature)

```text
specs/052-cli-add-vulnerability/
├── plan.md              # This file
├── research.md          # Phase 0 output
├── data-model.md        # Phase 1 output
├── quickstart.md        # Phase 1 output
├── contracts/           # Phase 1 output
└── tasks.md             # Phase 2 output (created by /speckit.tasks)
```

### Source Code (repository root)

```text
src/
├── cli/src/main/kotlin/com/secman/cli/
│   ├── commands/
│   │   └── AddVulnerabilityCommand.kt   # NEW: Picocli command
│   ├── service/
│   │   └── VulnerabilityCliService.kt   # NEW: CLI service layer
│   └── SecmanCli.kt                     # MODIFY: Add command routing
│
├── backendng/src/main/kotlin/com/secman/
│   ├── controller/
│   │   └── VulnerabilityManagementController.kt  # MODIFY: Add CLI endpoint
│   ├── service/
│   │   └── VulnerabilityService.kt               # MODIFY: Add upsert method
│   ├── repository/
│   │   └── VulnerabilityRepository.kt            # MODIFY: Add findByAssetAndVulnerabilityId
│   └── dto/
│       └── AddVulnerabilityRequestDto.kt         # NEW: Request DTO
```

**Structure Decision**: CLI module with backend API integration (matches existing `manage-user-mappings` pattern)

## Complexity Tracking

> No violations - implementation uses existing patterns with minimal additions.
