# Feature 021: Vulnerability Overdue & Exception Logic

## 📋 Overview

A comprehensive system for tracking overdue vulnerabilities and managing exceptions with high usability.

**Status**: 📝 Specification Complete - Ready for Implementation  
**Priority**: P1 - Core Security Feature  
**Estimated Effort**: 4-5 weeks (phased deployment)

## 🎯 Core Features

### 1️⃣ Configurable Overdue Threshold
- **"Reminder One"** setting (default: 30 days)
- Admin-only configuration
- Global organization setting
- Instant effect across all views

### 2️⃣ Visual Overdue Indicators
- 🔴 **OVERDUE** - Beyond threshold, no exception
- ✅ **OK** - Within acceptable age
- 🛡️ **EXCEPTED** - Active exception applied
- Shows days overdue count
- Filterable by status

### 3️⃣ Exception Management
- **Asset Exceptions**: By specific asset/IP
- **Product Exceptions**: By product/version pattern
- Time-bound with required end date
- Justification required
- ADMIN-only access
- Full CRUD operations

## 📊 Visual Example

```
Vulnerability List View:
┌─────────────────────────────────────────────────────────────────────┐
│ System      │ CVE          │ Severity │ Age    │ Status             │
├─────────────────────────────────────────────────────────────────────┤
│ server-01   │ CVE-2024-001 │ Critical │ 45d    │ 🔴 OVERDUE (15d)   │
│ server-02   │ CVE-2024-002 │ High     │ 25d    │ ✅ OK              │
│ server-03   │ CVE-2024-003 │ Critical │ 50d    │ 🛡️ EXCEPTED        │
└─────────────────────────────────────────────────────────────────────┘
```

## 🚀 Implementation Phases

### Phase 1: Foundation (Week 1) - ⭐ START HERE
**Deliverable**: Basic overdue tracking and configuration

- [x] Backend: VulnerabilityConfig entity, service, API
- [x] Backend: Overdue calculation logic
- [x] Frontend: Config form component
- [x] Frontend: Overdue status badge component
- [x] Frontend: Update vulnerability tables
- [x] Tests: Unit, integration, E2E
- [x] Database: Config table migration

**Acceptance**: Admin can set threshold, users see overdue badges

---

### Phase 2: Asset Exceptions (Week 2)
**Deliverable**: Asset-based exception management

- [ ] Backend: Extend exception entity for ASSET type
- [ ] Backend: Asset exception matching logic
- [ ] Frontend: Asset exception form
- [ ] Frontend: Exception management UI
- [ ] Tests: Exception workflows
- [ ] Database: Asset exception migration

**Acceptance**: Create asset exceptions that suppress overdue

---

### Phase 3: Product Enhancement (Week 3)
**Deliverable**: Improved product exception UX

- [ ] Backend: Affected vulnerability counts
- [ ] Backend: Query optimizations
- [ ] Frontend: Product selector/autocomplete
- [ ] Frontend: Impact preview
- [ ] Tests: Performance tests

**Acceptance**: Enhanced product exception management

---

### Phase 4: Full CRUD (Week 4)
**Deliverable**: Complete exception management

- [ ] Backend: Audit logging
- [ ] Backend: Exception detail endpoints
- [ ] Frontend: Edit/delete workflows
- [ ] Frontend: History views
- [ ] Tests: Lifecycle tests

**Acceptance**: Complete exception CRUD with audit

---

### Phase 5: Analytics (Week 5+)
**Deliverable**: Reporting and polish

- [ ] Backend: Analytics queries
- [ ] Frontend: Dashboard widgets
- [ ] Frontend: CSV export
- [ ] Documentation: User guide

**Acceptance**: Comprehensive analytics available

## 📁 Document Structure

```
specs/021-vulnerability-overdue-exception-logic/
├── README.md         ← You are here (overview)
├── spec.md           ← Detailed specification (30k words)
├── plan.md           ← Implementation plan (40k words)
└── quickstart.md     ← Quick reference guide
```

## 🎨 Usability Highlights

### Clear Visual Hierarchy
- Color-coded status badges
- Prominent table columns
- Consistent icons

### Intuitive Workflows
- One-click exception creation
- Inline status filters
- Smart form defaults
- Impact previews

### Contextual Help
- Tooltips everywhere
- Example text in forms
- Info cards with explanations
- Inline validation messages

### Feedback & Transparency
- Immediate success/error messages
- Exception details on hover
- Confirmation with impact preview
- Progress indicators

## 🗃️ Data Model Summary

### New: `vulnerability_config`
```
id (PK)
reminder_one_days (1-365, default: 30)
updated_by
created_at
updated_at
```

### Enhanced: `vulnerability_exception`
```
id (PK)
exception_type (IP, PRODUCT, ASSET)  ← ASSET is new
target_value
asset_id (FK to asset) ← New field
expiration_date
reason
created_by
created_at
updated_at
```

### Enhanced: Vulnerability DTOs
```
Added fields:
- ageInDays: int
- overdueStatus: enum (OK, OVERDUE, EXCEPTED)
- daysOverdue: int?
- exceptionId: long?
- exceptionReason: string?
- exceptionEndDate: datetime?
```

## 🔌 API Summary

### New Endpoints
```
GET  /api/admin/vulnerability-config      # Get config (ADMIN)
PUT  /api/admin/vulnerability-config      # Update config (ADMIN)
```

### Enhanced Endpoints
```
GET  /api/vulnerabilities/current         # Now includes overdueStatus
GET  /api/assets/{id}/vulnerabilities     # Now includes overdueStatus
POST /api/vulnerability-exceptions        # Now supports ASSET type
```

## ✅ Acceptance Criteria

### Phase 1 Complete When:
- ✅ Admin can configure Reminder One threshold
- ✅ Overdue status visible in all vulnerability views
- ✅ Status badges show correct colors and text
- ✅ Filters work for each status type
- ✅ All tests passing (unit, integration, E2E)
- ✅ Performance < 2s page load with 1000 records

### Full Feature Complete When:
- ✅ All 5 phases deployed
- ✅ Asset and product exceptions working
- ✅ Full CRUD operations functional
- ✅ Analytics dashboard live
- ✅ User documentation complete
- ✅ < 5% form error rate
- ✅ < 30s exception creation time
- ✅ 30%+ reduction in false positive alerts

## 📈 Success Metrics

### Functional
- Overdue tracking operational
- Exception suppression working
- CRUD operations complete

### Performance
- Vulnerability list < 2s load (1K records)
- Exception matching < 100ms overhead
- Dashboard analytics < 5s

### Usability
- Exception creation < 30s
- < 5% form submission errors
- Positive user feedback

### Business
- 30%+ reduction in false positives
- Better vulnerability prioritization
- Compliance reporting support

## 🚨 Key Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| Performance degradation | Indexes, caching, pagination |
| Exception type confusion | Clear UI labels, contextual help |
| Exception abuse | Admin-only, required expiration |
| Complex matching bugs | Comprehensive tests, clear spec |

## 🔗 Related Features

- **Feature 003**: Vulnerability Management (foundation)
- **Feature 004**: VULN Role & Exception UI
- **Feature 008**: Workgroup Access Control
- **Feature 013/016**: User mapping patterns

## 🛠️ Tech Stack

**Backend**:
- Kotlin 2.1.0
- Micronaut 4.4
- Hibernate JPA
- MariaDB 11.4

**Frontend**:
- React 19
- TypeScript
- Bootstrap 5.3
- Axios

## 📚 Next Steps

1. **Read** `spec.md` for complete requirements
2. **Review** `plan.md` for detailed implementation
3. **Use** `quickstart.md` as quick reference
4. **Start** with Phase 1, Task 1.1
5. **Test** continuously as you build
6. **Deploy** phases incrementally

## 💬 Questions?

- Design decisions: See **Open Questions** in `spec.md`
- Implementation details: See `plan.md`
- Quick reference: See `quickstart.md`
- Code patterns: Review existing features 003, 004

---

**Created**: 2025-10-15  
**Last Updated**: 2025-10-15  
**Status**: 📝 Ready for Implementation  
**Next Action**: Review spec.md and start Phase 1
