# Implementation Tasks: Vulnerability Overdue & Exception Logic

**Feature**: 021-vulnerability-overdue-exception-logic  
**Status**: Ready for Implementation

---

## Phase 1: Foundation (Week 1) - Core Overdue Tracking

### Backend Tasks

- [ ] **1.1** Create VulnerabilityConfig entity
  - File: `src/backendng/src/main/kotlin/com/secman/domain/VulnerabilityConfig.kt`
  - Fields: id, reminderOneDays, updatedBy, createdAt, updatedAt
  - Validation: reminderOneDays 1-365
  
- [ ] **1.2** Create VulnerabilityConfigRepository
  - File: `src/backendng/src/main/kotlin/com/secman/repository/VulnerabilityConfigRepository.kt`
  - Method: findFirstByOrderByIdAsc()
  
- [ ] **1.3** Create VulnerabilityConfigService
  - File: `src/backendng/src/main/kotlin/com/secman/service/VulnerabilityConfigService.kt`
  - Methods: getConfig(), updateConfig(), getReminderOneDays()
  - Auto-create default config
  
- [ ] **1.4** Create DTOs for Config and Overdue Status
  - Files: `VulnerabilityConfigDto.kt`, `OverdueStatus.kt`
  - Enum: OverdueStatus (OK, OVERDUE, EXCEPTED)
  
- [ ] **1.5** Add overdue calculation to VulnerabilityService
  - File: `src/backendng/src/main/kotlin/com/secman/service/VulnerabilityService.kt`
  - Method: calculateOverdueStatus()
  - Data class: OverdueInfo
  
- [ ] **1.6** Enhance VulnerabilityWithExceptionDto
  - File: `src/backendng/src/main/kotlin/com/secman/dto/VulnerabilityWithExceptionDto.kt`
  - Add: ageInDays, overdueStatus, daysOverdue, exception fields
  
- [ ] **1.7** Create VulnerabilityConfigController
  - File: `src/backendng/src/main/kotlin/com/secman/controller/VulnerabilityConfigController.kt`
  - Endpoints: GET/PUT /api/admin/vulnerability-config
  - ADMIN-only access
  
- [ ] **1.8** Update vulnerability query methods
  - File: `src/backendng/src/main/kotlin/com/secman/service/VulnerabilityService.kt`
  - Update: getCurrentVulnerabilities() to include overdue status
  - Add filtering by overdue status
  
- [ ] **1.9** Database migration
  - File: `src/backendng/src/main/resources/db/migration/V1_XX__add_vulnerability_config.sql`
  - Create vulnerability_config table
  - Insert default config (30 days)
  - Add index on vulnerability.scan_timestamp

### Frontend Tasks

- [ ] **1.10** Create VulnerabilityConfigForm component
  - File: `src/frontend/src/components/VulnerabilityConfigForm.tsx`
  - Form with reminder days input
  - Validation and error handling
  - Success feedback
  
- [ ] **1.11** Create OverdueStatusBadge component
  - File: `src/frontend/src/components/OverdueStatusBadge.tsx`
  - Color-coded badges (red/green/blue)
  - Tooltips with details
  - Reusable across all views
  
- [ ] **1.12** Update CurrentVulnerabilitiesTable
  - File: `src/frontend/src/components/CurrentVulnerabilitiesTable.tsx`
  - Add overdue status column
  - Add status filter dropdown
  - Use OverdueStatusBadge component
  
- [ ] **1.13** Update AdminPage with config link
  - File: `src/frontend/src/components/AdminPage.tsx`
  - Add "Vulnerability Settings" card
  - Link to /admin/vulnerability-config

### Testing Tasks

- [ ] **1.14** Unit tests for VulnerabilityConfigService
  - File: `src/backendng/src/test/kotlin/com/secman/service/VulnerabilityConfigServiceTest.kt`
  - Test: getConfig, updateConfig, default creation
  
- [ ] **1.15** Integration tests for Config API
  - File: `src/backendng/src/test/kotlin/com/secman/controller/VulnerabilityConfigControllerTest.kt`
  - Test: GET/PUT endpoints, ADMIN auth, validation
  
- [ ] **1.16** Unit tests for overdue calculation
  - File: `src/backendng/src/test/kotlin/com/secman/service/VulnerabilityServiceOverdueTest.kt`
  - Test: OK, OVERDUE, EXCEPTED statuses
  
- [ ] **1.17** E2E tests for config management
  - File: `src/frontend/tests/e2e/vulnerability-config.spec.ts`
  - Test: Complete config workflow

**Phase 1 Done When**: ✅ Admin can configure threshold, users see overdue badges

---

## Phase 2: Asset Exceptions (Week 2)

### Backend Tasks

- [ ] **2.1** Extend VulnerabilityException entity
  - File: `src/backendng/src/main/kotlin/com/secman/domain/VulnerabilityException.kt`
  - Add: ASSET to ExceptionType enum
  - Add: asset relationship (ManyToOne)
  
- [ ] **2.2** Update VulnerabilityException matching logic
  - File: `src/backendng/src/main/kotlin/com/secman/domain/VulnerabilityException.kt`
  - Update: matches() method for ASSET type
  
- [ ] **2.3** Database migration for asset exceptions
  - File: `src/backendng/src/main/resources/db/migration/V1_YY__add_asset_exception.sql`
  - Add asset_id column
  - Add foreign key constraint
  - Add index
  
- [ ] **2.4** Update exception DTOs
  - File: `src/backendng/src/main/kotlin/com/secman/dto/VulnerabilityExceptionDto.kt`
  - Add: assetId, assetName fields
  
- [ ] **2.5** Enhance VulnerabilityExceptionService
  - File: `src/backendng/src/main/kotlin/com/secman/service/VulnerabilityExceptionService.kt`
  - Update: createException() to support ASSET type
  - Update: getAllExceptions() to include asset info

### Frontend Tasks

- [ ] **2.6** Create AssetExceptionForm component
  - File: `src/frontend/src/components/AssetExceptionForm.tsx`
  - Asset selector dropdown
  - End date picker
  - Reason textarea
  - Validation
  
- [ ] **2.7** Update VulnerabilityExceptionsTable
  - File: `src/frontend/src/components/VulnerabilityExceptionsTable.tsx`
  - Support ASSET exception type
  - Show asset name in table
  - Type selection in create modal
  
- [ ] **2.8** Create exception type selector
  - Modal with radio buttons: IP / PRODUCT / ASSET
  - Conditional form based on selection
  - Help text for each type

### Testing Tasks

- [ ] **2.9** Unit tests for asset exception matching
  - Test: ASSET type matching logic
  - Test: Backward compatibility with IP/PRODUCT
  
- [ ] **2.10** Integration tests for asset exceptions
  - Test: Create ASSET exception via API
  - Test: Asset exception suppresses overdue
  
- [ ] **2.11** E2E tests for asset exception workflow
  - Test: Complete asset exception creation
  - Test: Verify suppression in UI
  - Test: Exception expiration

**Phase 2 Done When**: ✅ Asset exceptions can be created and suppress overdue status

---

## Phase 3: Product Exception Enhancement (Week 3)

### Backend Tasks

- [ ] **3.1** Add affected vulnerability count query
  - File: `src/backendng/src/main/kotlin/com/secman/repository/VulnerabilityRepository.kt`
  - Query: Count vulnerabilities matching product pattern
  
- [ ] **3.2** Update exception DTOs with affected count
  - File: `src/backendng/src/main/kotlin/com/secman/dto/VulnerabilityExceptionDto.kt`
  - Add: affectedVulnerabilityCount field
  
- [ ] **3.3** Optimize exception matching queries
  - Add database indexes
  - Add caching for exception evaluations
  
- [ ] **3.4** Create exception impact endpoint
  - Endpoint: GET /api/vulnerability-exceptions/{id}/affected
  - Returns: List of affected vulnerabilities

### Frontend Tasks

- [ ] **3.5** Update exception table with affected count
  - File: `src/frontend/src/components/VulnerabilityExceptionsTable.tsx`
  - Show affected count column
  - Link to view affected vulnerabilities
  
- [ ] **3.6** Create product selector with autocomplete
  - Component: ProductSelector
  - Fetch unique product names from API
  - Autocomplete as user types
  
- [ ] **3.7** Add impact preview before creating exception
  - Modal: Show affected vulnerabilities
  - Count by severity
  - Confirm button

### Testing Tasks

- [ ] **3.8** Performance tests for exception matching
  - Test with 10,000+ vulnerabilities
  - Test with 100+ exceptions
  - Verify < 100ms overhead
  
- [ ] **3.9** E2E tests for product exception enhancement
  - Test product autocomplete
  - Test impact preview
  - Test affected count display

**Phase 3 Done When**: ✅ Product exceptions show affected counts and have improved UX

---

## Phase 4: Exception Management (Week 4)

### Backend Tasks

- [ ] **4.1** Add audit logging for exceptions
  - Track all CRUD operations
  - Log user, timestamp, changes
  
- [ ] **4.2** Create exception detail endpoint
  - Endpoint: GET /api/vulnerability-exceptions/{id}
  - Include full details and affected vulnerabilities
  
- [ ] **4.3** Enhance update exception logic
  - Validate date changes
  - Re-evaluate affected vulnerabilities
  - Log changes

### Frontend Tasks

- [ ] **4.4** Implement edit exception functionality
  - Modal pre-filled with current values
  - All fields editable except type
  - Validation
  
- [ ] **4.5** Add confirmation dialog for delete
  - Show impact: "X vulnerabilities will become overdue"
  - Require confirmation
  - Success/error feedback
  
- [ ] **4.6** Create exception history view
  - Show audit log of changes
  - Filter by user, date, type
  - Export to CSV

### Testing Tasks

- [ ] **4.7** Unit tests for exception lifecycle
  - Test: Edit updates correctly
  - Test: Delete removes and logs
  - Test: Audit trail complete
  
- [ ] **4.8** E2E tests for edit/delete workflows
  - Test: Complete edit workflow
  - Test: Complete delete workflow
  - Test: History view

**Phase 4 Done When**: ✅ Full CRUD operations on exceptions with audit logging

---

## Phase 5: Analytics & Polish (Week 5+)

### Backend Tasks

- [ ] **5.1** Create exception analytics queries
  - Total active exceptions
  - Exceptions by type
  - Top reasons
  - Trend over time
  
- [ ] **5.2** Create analytics endpoints
  - Endpoint: GET /api/admin/vulnerability-analytics
  - Dashboard stats
  - Historical data

### Frontend Tasks

- [ ] **5.3** Create exception dashboard widget
  - Card showing key metrics
  - Charts: type breakdown, trend
  - Link to full analytics
  
- [ ] **5.4** Add filtering and sorting to tables
  - Filter by type, status, date
  - Sort by any column
  - Save preferences
  
- [ ] **5.5** Implement CSV export
  - Export exceptions
  - Export affected vulnerabilities
  - Include all fields
  
- [ ] **5.6** Create exception detail page
  - Show full exception info
  - List all affected vulnerabilities
  - Edit/delete actions

### Testing Tasks

- [ ] **5.7** Load tests for analytics
  - Test with full dataset
  - Verify < 5s response
  - Check caching

### Documentation Tasks

- [ ] **5.8** User guide for exception management
  - Screenshots
  - Step-by-step workflows
  - Best practices
  
- [ ] **5.9** Admin documentation
  - Configuration guide
  - Troubleshooting
  - FAQ

**Phase 5 Done When**: ✅ Comprehensive analytics and polished UX

---

## General Tasks (Throughout)

### Code Quality

- [ ] Code reviews for all PRs
- [ ] Follow Kotlin/TypeScript style guides
- [ ] Maintain test coverage > 80%
- [ ] Document complex logic

### Performance

- [ ] Profile database queries
- [ ] Add indexes where needed
- [ ] Implement caching strategically
- [ ] Monitor page load times

### Security

- [ ] Verify ADMIN-only access
- [ ] Input validation on all forms
- [ ] SQL injection prevention
- [ ] XSS prevention

### Documentation

- [ ] Update API documentation
- [ ] Update database schema docs
- [ ] Create user guides
- [ ] Update CHANGELOG

---

## Completion Checklist

### Phase 1 ✅
- [ ] All Phase 1 tasks completed
- [ ] Tests passing
- [ ] Code reviewed
- [ ] Deployed to staging
- [ ] Tested by QA
- [ ] Deployed to production

### Phase 2 ✅
- [ ] All Phase 2 tasks completed
- [ ] Tests passing
- [ ] Code reviewed
- [ ] Deployed to staging
- [ ] Tested by QA
- [ ] Deployed to production

### Phase 3 ✅
- [ ] All Phase 3 tasks completed
- [ ] Tests passing
- [ ] Performance benchmarks met
- [ ] Code reviewed
- [ ] Deployed to production

### Phase 4 ✅
- [ ] All Phase 4 tasks completed
- [ ] Audit logging verified
- [ ] Tests passing
- [ ] Code reviewed
- [ ] Deployed to production

### Phase 5 ✅
- [ ] All Phase 5 tasks completed
- [ ] Analytics working
- [ ] Documentation complete
- [ ] User training done
- [ ] Deployed to production

---

**Total Tasks**: ~60 tasks across 5 phases  
**Estimated Time**: 4-5 weeks  
**Priority**: P1 - Core Security Feature

---

**Next Action**: Start with Task 1.1 - Create VulnerabilityConfig entity
