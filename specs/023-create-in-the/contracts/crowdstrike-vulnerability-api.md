# CrowdStrike Vulnerability API Contract

**Feature**: 023-create-in-the  
**API**: CrowdStrike Spotlight Vulnerability Service  
**Base URL**: `https://api.crowdstrike.com`

## Overview

This contract defines the vulnerability query endpoints for retrieving security vulnerabilities associated with hosts in CrowdStrike Falcon. The CLI uses these endpoints to query vulnerability data.

---

## Endpoint: Query Vulnerabilities by Host

**Method**: `GET`  
**Path**: `/spotlight/combined/vulnerabilities/v1`  
**Authentication**: Bearer token (from OAuth2 authentication)

### Request

**Headers**:
```http
Authorization: Bearer {access_token}
Accept: application/json
```

**Query Parameters**:

| Parameter | Type | Required | Description | Example |
|-----------|------|----------|-------------|---------|
| `filter` | string | Yes | FQL filter expression for host | `hostname:'web-server-01'` |
| `limit` | integer | No | Maximum results per page (default: 100, max: 5000) | `100` |
| `offset` | integer | No | Pagination offset | `0` |
| `sort` | string | No | Sort field and direction | `severity|desc` |

**FQL Filter Syntax**:
- By hostname: `hostname:'web-server-01.example.com'`
- By host ID: `host_id:'abc123xyz'`
- By severity: `severity:'CRITICAL'`
- Multiple conditions: `hostname:'web-server-01'+severity:'HIGH'`

**Example Request**:
```http
GET /spotlight/combined/vulnerabilities/v1?filter=hostname:'web-server-01'&limit=100 HTTP/1.1
Host: api.crowdstrike.com
Authorization: Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6...
Accept: application/json
```

---

### Response: Success (200 OK)

**Status Code**: `200 OK`  
**Content-Type**: `application/json`

**Body**:
```json
{
  "meta": {
    "query_time": 0.123,
    "pagination": {
      "limit": 100,
      "offset": 0,
      "total": 15
    },
    "powered_by": "spotlight-api",
    "trace_id": "trace-abc123"
  },
  "resources": [
    {
      "id": "vuln-001",
      "cid": "customer-id-123",
      "aid": "agent-id-456",
      "created_timestamp": "2024-03-15T10:30:00Z",
      "updated_timestamp": "2024-03-15T10:30:00Z",
      "status": "open",
      "cve": {
        "id": "CVE-2024-1234",
        "base_score": 9.8,
        "severity": "CRITICAL",
        "exploit_status": 1,
        "exprt_rating": "HIGH",
        "published_date": "2024-03-10",
        "description": "Remote code execution vulnerability in OpenSSL versions prior to 1.1.1w. An attacker can execute arbitrary code...",
        "remediation": "Update OpenSSL to version 1.1.1w or later"
      },
      "host_info": {
        "hostname": "web-server-01.example.com",
        "local_ip": "192.168.1.100",
        "os_version": "Ubuntu 20.04.6 LTS",
        "machine_domain": "example.com",
        "ou": "Servers/Web",
        "site_name": "Production",
        "platform_name": "Linux",
        "last_seen": "2024-03-15T14:23:45Z"
      },
      "apps": [
        {
          "product_name": "OpenSSL",
          "product_name_version": "OpenSSL 1.1.1t",
          "vendor": "OpenSSL Project"
        }
      ],
      "suppression_info": null
    }
  ],
  "errors": []
}
```

**Key Fields**:

| Field | Type | Description |
|-------|------|-------------|
| `resources` | array | List of vulnerabilities |
| `resources[].cve.id` | string | CVE identifier |
| `resources[].cve.severity` | string | Severity: CRITICAL, HIGH, MEDIUM, LOW |
| `resources[].cve.base_score` | number | CVSS base score (0.0-10.0) |
| `resources[].cve.description` | string | Vulnerability description |
| `resources[].cve.remediation` | string | Remediation guidance |
| `resources[].cve.published_date` | string | CVE publication date (YYYY-MM-DD) |
| `resources[].host_info.hostname` | string | Host fully qualified domain name |
| `resources[].apps[]` | array | Affected software packages |

**Mapping to Domain Model**:
```kotlin
resources.map { resource ->
    Vulnerability(
        cveId = resource.cve.id,
        severity = SeverityLevel.valueOf(resource.cve.severity),
        affectedSoftware = resource.apps.joinToString { "${it.product_name} ${it.product_name_version}" },
        description = resource.cve.description.take(100),
        descriptionFull = resource.cve.description,
        cvssScore = resource.cve.base_score,
        publishedDate = LocalDate.parse(resource.cve.published_date),
        remediation = resource.cve.remediation
    )
}

Host(
    hostname = resource.host_info.hostname,
    hostId = resource.aid,
    operatingSystem = resource.host_info.os_version,
    ipAddress = resource.host_info.local_ip,
    lastSeen = Instant.parse(resource.host_info.last_seen),
    vulnerabilities = vulnerabilities
)
```

---

### Response: No Vulnerabilities Found (200 OK)

**Status Code**: `200 OK`  
**Content-Type**: `application/json`

**Body**:
```json
{
  "meta": {
    "query_time": 0.045,
    "pagination": {
      "limit": 100,
      "offset": 0,
      "total": 0
    },
    "powered_by": "spotlight-api",
    "trace_id": "trace-xyz789"
  },
  "resources": [],
  "errors": []
}
```

**Handling**:
- User message: "No vulnerabilities found for host: {hostname}"
- Exit code: 0 (not an error)
- Return empty Host with empty vulnerabilities list

---

### Response: Authentication Required (401 Unauthorized)

**Status Code**: `401 Unauthorized`  
**Content-Type**: `application/json`

**Body**:
```json
{
  "meta": {
    "query_time": 0.001,
    "powered_by": "spotlight-api",
    "trace_id": "trace-error-123"
  },
  "resources": [],
  "errors": [
    {
      "code": 401,
      "message": "access denied, invalid bearer token"
    }
  ]
}
```

**Error Handling**:
- Invalidate cached token
- Retry authentication (get new token)
- Retry original request with new token
- If still fails, user message: "Authentication failed. Please verify your credentials."
- Exit code: 1

---

### Response: Host Not Found (404 Not Found)

**Status Code**: `404 Not Found`  
**Content-Type**: `application/json`

**Body**:
```json
{
  "meta": {
    "query_time": 0.012,
    "powered_by": "spotlight-api",
    "trace_id": "trace-notfound-456"
  },
  "resources": [],
  "errors": [
    {
      "code": 404,
      "message": "host not found"
    }
  ]
}
```

**Error Handling**:
- Do NOT retry
- User message: "Host not found in CrowdStrike: {hostname}"
- For bulk queries: continue with next host, add to errors list
- Exit code: 1 (for single query), 0 (for bulk if some succeeded)

---

### Response: Rate Limit (429 Too Many Requests)

**Status Code**: `429 Too Many Requests`  
**Content-Type**: `application/json`

**Headers**:
```http
X-RateLimit-Limit: 6000
X-RateLimit-Remaining: 0
X-RateLimit-RetryAfter: 30
Retry-After: 30
```

**Body**:
```json
{
  "meta": {
    "query_time": 0.001,
    "powered_by": "spotlight-api",
    "trace_id": "trace-ratelimit-789"
  },
  "resources": [],
  "errors": [
    {
      "code": 429,
      "message": "rate limit exceeded"
    }
  ]
}
```

**Error Handling**:
- Retry with exponential backoff (respect Retry-After header)
- User message: "Rate limit exceeded. Retrying in {delay} seconds... (attempt {n} of 5)"
- Max retries: 5
- If all retries exhausted: exit code 1

---

### Response: Server Error (500 Internal Server Error)

**Status Code**: `500 Internal Server Error` (or 502, 503, 504)  
**Content-Type**: `application/json`

**Body**:
```json
{
  "meta": {
    "query_time": 0.001,
    "powered_by": "spotlight-api",
    "trace_id": "trace-error-999"
  },
  "resources": [],
  "errors": [
    {
      "code": 500,
      "message": "internal server error"
    }
  ]
}
```

**Error Handling**:
- Retry with exponential backoff
- User message: "CrowdStrike API error. Retrying... (attempt {n} of 3)"
- Max retries: 3
- Exit code: 1 if all retries fail

---

## Pagination

For hosts with many vulnerabilities (>100), implement pagination:

```kotlin
fun queryAllVulnerabilities(hostname: String): List<Vulnerability> {
    val allVulnerabilities = mutableListOf<Vulnerability>()
    var offset = 0
    val limit = 100
    
    do {
        val response = queryVulnerabilities(hostname, limit, offset)
        allVulnerabilities.addAll(response.resources)
        offset += limit
    } while (response.meta.pagination.total > offset)
    
    return allVulnerabilities
}
```

---

## Filtering by Severity

Apply severity filter in two ways:

**Option 1: API-side filtering (preferred)**:
```
GET /spotlight/combined/vulnerabilities/v1?filter=hostname:'web-server-01'+severity:'CRITICAL'
```

**Option 2: Client-side filtering**:
- Fetch all vulnerabilities
- Filter in Kotlin: `vulnerabilities.filter { it.severity == SeverityLevel.CRITICAL }`

Use Option 1 to reduce network traffic and response size.

---

## Test Cases

### Contract Test 1: Successful Query
```kotlin
@Test
fun `should query vulnerabilities for host`() {
    mockServer.enqueue(MockResponse()
        .setResponseCode(200)
        .setBody(/* JSON response with vulnerabilities */)
    )
    
    val service = VulnerabilityService(...)
    val host = service.queryVulnerabilities("web-server-01")
    
    assertThat(host.hostname).isEqualTo("web-server-01")
    assertThat(host.vulnerabilities).hasSize(15)
    assertThat(host.vulnerabilities[0].cveId).isEqualTo("CVE-2024-1234")
}
```

### Contract Test 2: No Vulnerabilities
```kotlin
@Test
fun `should return empty list when no vulnerabilities found`() {
    mockServer.enqueue(MockResponse()
        .setResponseCode(200)
        .setBody("""{"meta":{"pagination":{"total":0}},"resources":[],"errors":[]}""")
    )
    
    val service = VulnerabilityService(...)
    val host = service.queryVulnerabilities("clean-server")
    
    assertThat(host.vulnerabilities).isEmpty()
}
```

### Contract Test 3: Pagination
```kotlin
@Test
fun `should paginate through all vulnerabilities`() {
    // First page: 100 results
    mockServer.enqueue(MockResponse()
        .setResponseCode(200)
        .setBody(/* 100 vulnerabilities, total=150 */)
    )
    // Second page: 50 results
    mockServer.enqueue(MockResponse()
        .setResponseCode(200)
        .setBody(/* 50 vulnerabilities, total=150 */)
    )
    
    val service = VulnerabilityService(...)
    val host = service.queryAllVulnerabilities("big-server")
    
    assertThat(host.vulnerabilities).hasSize(150)
    assertThat(mockServer.requestCount).isEqualTo(2)
}
```

---

## References

- [CrowdStrike Spotlight API Documentation](https://falcon.crowdstrike.com/documentation/98/spotlight-apis)
- [FQL (Falcon Query Language) Syntax](https://falcon.crowdstrike.com/documentation/45/falcon-query-language-fql)
