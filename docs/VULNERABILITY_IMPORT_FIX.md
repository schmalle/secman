# Vulnerability Import Button Fix

## Issue
When clicking the "Import Vulnerabilities" button, nothing happened. No error messages, no API calls - complete silence.

## Root Cause
**JWT Token Storage Mismatch**

The Login component and vulnerabilityService were using different storage mechanisms for the JWT token:

- **Login component** (`Login.tsx:59`): Stores token in `localStorage` as `authToken`
  ```typescript
  localStorage.setItem('authToken', data.token);
  ```

- **vulnerabilityService** (BEFORE FIX): Looked for token in `sessionStorage` as `jwtToken`
  ```typescript
  const token = sessionStorage.getItem('jwtToken');  // ❌ WRONG
  ```

Since `sessionStorage.getItem('jwtToken')` always returned `null`, the service would throw an error before making any API call, causing the button click to silently fail.

## Fix Applied
Changed `vulnerabilityService.ts` to use the correct storage location and key name:

```typescript
// Fixed in uploadVulnerabilityFile() and getAssetVulnerabilities()
const token = localStorage.getItem('authToken');  // ✓ CORRECT
```

### Files Modified
1. `/Users/flake/sources/misc/secman/src/frontend/src/services/vulnerabilityService.ts`
   - Line 50: Changed `sessionStorage.getItem('jwtToken')` to `localStorage.getItem('authToken')`
   - Line 114: Changed `sessionStorage.getItem('jwtToken')` to `localStorage.getItem('authToken')`

## Verification
All other services in the codebase consistently use `localStorage.getItem('authToken')`:
- `auth.ts:14`
- `auth-init.ts:22,51`
- `McpApiKeyManagement.tsx:52,88,139`
- `McpDashboard.tsx:63`
- `Header.tsx:23`

The vulnerabilityService was the **only** service using the wrong storage mechanism.

## Additional Improvements
Added comprehensive console logging to aid future debugging:
- `[VulnerabilityImport]` logs in VulnerabilityImportForm.tsx
- `[VulnerabilityService]` logs in vulnerabilityService.ts

These logs track:
- Button click events
- File and scan date validation
- JWT token presence
- API call execution
- Response handling

## Testing
1. **Frontend dev server restarted**: Ensures updated code is loaded
2. **Auto-reload confirmed**: Dev server detected changes at 15:48:29 and 15:48:35
3. **Browser refresh needed**: Users should hard-refresh (Cmd+Shift+R / Ctrl+Shift+F5) to clear cached JavaScript

## How to Test
1. Refresh browser at `http://localhost:4321/import`
2. Ensure you're logged in (check `localStorage.authToken` in DevTools)
3. Select the "Vulnerabilities" tab
4. Choose file: `/Users/flake/sources/misc/secman/vulns.xlsx`
5. Verify scan date is set
6. Click "Import Vulnerabilities"
7. Expected: Upload succeeds with import summary displayed

## Console Logs to Expect (DevTools Console)
```
[VulnerabilityImport] Upload button clicked
[VulnerabilityImport] File: vulns.xlsx
[VulnerabilityImport] Scan date: 2025-10-03T15:40
[VulnerabilityImport] Starting upload...
[VulnerabilityImport] ISO scan date: 2025-10-03T15:40:00
[VulnerabilityService] uploadVulnerabilityFile called
[VulnerabilityService] File: vulns.xlsx Size: 9226
[VulnerabilityService] Scan date: 2025-10-03T15:40:00
[VulnerabilityService] JWT token present: true
[VulnerabilityService] Calling API: /api/import/upload-vulnerability-xlsx
[VulnerabilityService] Response status: 200
[VulnerabilityService] Response ok: true
[VulnerabilityService] Success response: {...}
[VulnerabilityImport] Upload successful: {...}
```

---

**Date**: 2025-10-03
**Status**: ✅ **FIXED**
**Dev Server**: Running on http://localhost:4321/ (auto-reload enabled)
